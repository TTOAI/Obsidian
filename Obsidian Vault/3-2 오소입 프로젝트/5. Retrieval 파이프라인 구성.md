# â­ **5ë‹¨ê³„ ì „ì²´ ëª©í‘œ ìš”ì•½**

âœ” ì‚¬ìš©ìì˜ ì§ˆë¬¸(query)ì„ embedding  
âœ” Qdrantì—ì„œ ê´€ë ¨ chunk ê²€ìƒ‰  
âœ” ì—¬ëŸ¬ chunkë¥¼ í•˜ë‚˜ì˜ contextë¡œ í•©ì¹˜ê¸°  
âœ” LLMì—ê²Œ ì „ë‹¬í•  Prompt í…œí”Œë¦¿ ì¤€ë¹„

ì¦‰,

> ğŸ”¥ â€œê²€ìƒ‰ ê²°ê³¼ë¥¼ LLMì´ ë‹µë³€í•  ìˆ˜ ìˆë„ë¡ ë³€í™˜í•˜ëŠ” ë‹¨ê³„â€

ë‹¤ìŒ ë‹¨ê³„ì¸ **6ë‹¨ê³„(LLM í˜¸ì¶œ)**ì—ì„œ ì‚¬ìš©ë¨.

---

# ğŸš€ **Step 5-1 â€” Retrieval Service ë§Œë“¤ê¸°**

ğŸ“ `backend/app/services/retriever.py` íŒŒì¼ ìƒì„±:

```python
from app.services.embedding import get_embedding
from app.services.qdrant_client import QdrantDB

class Retriever:
    def __init__(self, top_k=5):
        self.db = QdrantDB()
        self.top_k = top_k

    def retrieve(self, query: str):
        # 1) ì§ˆë¬¸ì„ embedding
        query_vec = get_embedding(query)

        # 2) Qdrantì—ì„œ ì˜ë¯¸ ê¸°ë°˜ ê²€ìƒ‰
        hits = self.db.search(query_vec, top_k=self.top_k)

        # 3) ê²°ê³¼ ì •ë¦¬
        contexts = []
        for h in hits:
            contexts.append(h.payload["text"])

        return contexts
```

---

# ğŸš€ **Step 5-2 â€” Prompt êµ¬ì„± í•¨ìˆ˜ ë§Œë“¤ê¸°**

LLMì—ê²Œ ì „ë‹¬í•  promptëŠ” ê¼­ ì•„ë˜ êµ¬ì¡°ë¥¼ ë”°ë¼ì•¼ í•¨:

```
[ë¬¸ì„œ ì»¨í…ìŠ¤íŠ¸]
ì§€ê¸ˆë¶€í„° ìœ„ ë¬¸ì„œë¥¼ ì°¸ê³ í•´ì„œ ì§ˆë¬¸ì— ë‹µí•´ë¼.
ì§ˆë¬¸: {query}
```

ğŸ“ `backend/app/services/prompter.py` ìƒì„±:

```python
def build_prompt(query: str, contexts: list[str]):
    context_text = "\n\n".join(contexts)

    prompt = (
        "ë‹¤ìŒì€ ì°¸ê³ í•  ë¬¸ì„œ ì¡°ê°ë“¤ì´ë‹¤.\n"
        "----------------------\n"
        f"{context_text}\n"
        "----------------------\n"
        "ìœ„ ë¬¸ì„œ ë‚´ìš©ì„ ì°¸ê³ í•´ì„œ ë‹µë³€í•˜ë¼. "
        "ë¬¸ì„œì— ì—†ëŠ” ë‚´ìš©ì€ ì¶”ì¸¡í•˜ì§€ ë§ê³  'ì •ë³´ ì—†ìŒ'ì´ë¼ê³  ë§í•´ë¼.\n\n"
        f"ì§ˆë¬¸: {query}\n"
        "ë‹µë³€:"
    )

    return prompt
```

---

# ğŸš€ **Step 5-3 â€” Retrieval + Prompt API ë§Œë“¤ê¸°**

LLM í˜¸ì¶œê¹Œì§€ í•  ìˆ˜ ìˆê²Œ ì¤€ë¹„ë§Œ í•´ë‘ëŠ” ë‹¨ê³„.

ğŸ“ `backend/app/routers/query.py` ìƒì„±:

```python
from fastapi import APIRouter
from app.services.retriever import Retriever
from app.services.prompter import build_prompt

router = APIRouter()

@router.get("/build-query")
def build_query(q: str):
    retriever = Retriever(top_k=5)
    contexts = retriever.retrieve(q)

    prompt = build_prompt(q, contexts)

    return {
        "query": q,
        "context_count": len(contexts),
        "prompt_preview": prompt[:500]  # ë„ˆë¬´ ê¸¸ë©´ ì¼ë¶€ë§Œ ë³´ì—¬ì£¼ê¸°
    }
```

ì´ APIëŠ” LLMì„ í˜¸ì¶œí•˜ì§€ ì•Šê³  **prompt êµ¬ì„±ë§Œ ë³´ì—¬ì£¼ëŠ” í…ŒìŠ¤íŠ¸ API**ì•¼.  
(6ë‹¨ê³„ì—ì„œ LLMì„ ë¶™ì¼ ì˜ˆì •)

---

# ğŸš€ **Step 5-4 â€” main.pyì— ë¼ìš°í„° ì¶”ê°€**

ğŸ“ `backend/main.py`

```python
from app.routers import ingest, search, test_embed, query

app.include_router(query.router)
```

---

# ğŸš€ **Step 5-5 â€” Docker ì¬ì‹œì‘ í›„ í…ŒìŠ¤íŠ¸**

```bash
docker compose down
docker compose up --build -d
```

---

# ğŸš€ **Step 5-6 â€” Retrieval íŒŒì´í”„ë¼ì¸ ë™ì‘ í™•ì¸**

### â‘  ë¬¸ì„œ ingest

POST `/ingest`  
â†’ chunk + embedding ì €ì¥ë¨

### â‘¡ ê²€ìƒ‰ (optional)

GET `/search?q=ë¬¸ì„œê´€ë¦¬`

### â‘¢ Retrieval + Prompt í™•ì¸

GET `/build-query?q=ë¬¸ì„œê´€ë¦¬`

ì˜ˆìƒ ê²°ê³¼:

```json
{
  "query": "ë¬¸ì„œê´€ë¦¬",
  "context_count": 3,
  "prompt_preview": "ë‹¤ìŒì€ ì°¸ê³ í•  ë¬¸ì„œ ì¡°ê°ë“¤ì´ë‹¤..."
}
```

ì´ì œ ì§ˆë¬¸ì— ëŒ€í•´ ì–´ë–¤ ë¬¸ì„œ ì¡°ê°ì´ ì„ íƒë˜ê³ , LLMì— ì–´ë–¤ promptê°€ ì „ë‹¬ë ì§€ í™•ì¸í•  ìˆ˜ ìˆìŒ.

---

# ğŸ‰ **5ë‹¨ê³„ê°€ ëë‚˜ë©´ ìš°ë¦¬ëŠ” ì–´ë–¤ ìƒíƒœì¼ê¹Œ?**

| ê¸°ëŠ¥                | ì™„ì„± ì—¬ë¶€ |
| ----------------- | ----- |
| ì§ˆë¬¸ â†’ embedding    | âœ”     |
| Qdrantì—ì„œ ê´€ë ¨ ë¬¸ì„œ ê²€ìƒ‰ | âœ”     |
| ê²€ìƒ‰ëœ chunk ì·¨í•©      | âœ”     |
| prompt ìƒì„±         | âœ”     |
| LLMì—ê²Œ ì „ë‹¬í•  ì¤€ë¹„ ì™„ë£Œ   | âœ”     |

ì¦‰, **Retrieval-Augmented Generation ì¤‘ "Retrieval" ë¶€ë¶„ì´ ì™„ì„±ëœ ìƒíƒœ!**

---
