# ğŸ¯ **4ë‹¨ê³„ ëª©í‘œ**

âœ” Qdrant ì»¬ë ‰ì…˜ ìƒì„±  
âœ” chunk + embeddingì„ vector DBì— ì €ì¥(upsert)  
âœ” íŠ¹ì • ì§ˆë¬¸ embeddingì„ ê¸°ë°˜ìœ¼ë¡œ ê²€ìƒ‰(search) ê¸°ëŠ¥ êµ¬í˜„  
âœ” ingestion â†’ embedding â†’ ì €ì¥ end-to-end ì™„ì„±

ì´ì œ í•˜ë‚˜ì”© ì§„í–‰í•´ë³´ì!

---

# â­ Step 4-1 â€” Qdrant í´ë¼ì´ì–¸íŠ¸ ì„¤ì • (qdrant_client.py)

ğŸ“ `backend/app/services/qdrant_client.py` ìƒì„±:

```python
import os
from qdrant_client import QdrantClient
from qdrant_client.http.models import VectorParams, Distance

QDRANT_URL = os.getenv("QDRANT_URL", "http://qdrant:6333")

COLLECTION_NAME = "documents"

class QdrantDB:
    def __init__(self):
        self.client = QdrantClient(url=QDRANT_URL)

    def create_collection(self, vector_size: int = 384):
        """
        ë²¡í„° ì €ì¥ì„ ìœ„í•œ ì»¬ë ‰ì…˜ ìƒì„± (ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ìƒì„±)
        """
        collections = self.client.get_collections().collections
        names = [c.name for c in collections]

        if COLLECTION_NAME not in names:
            self.client.create_collection(
                COLLECTION_NAME,
                vectors_config=VectorParams(
                    size=vector_size,
                    distance=Distance.COSINE
                )
            )
            print(f"Qdrant collection '{COLLECTION_NAME}' created.")

    def upsert_points(self, points: list):
        """
        points = [
           {
             "id": "...",
             "vector": [...],
             "payload": {...}
           },
           ...
        ]
        """
        self.client.upsert(
            collection_name=COLLECTION_NAME,
            points=points
        )

    def search(self, query_vector, top_k=5):
        """
        ìœ ì‚¬ë„ ê¸°ë°˜ ê²€ìƒ‰ ê¸°ëŠ¥
        """
        hits = self.client.search(
            collection_name=COLLECTION_NAME,
            query_vector=query_vector,
            limit=top_k
        )
        return hits
```

---

# â­ Step 4-2 â€” ingestionì„ embedding + Qdrant ì €ì¥ê¹Œì§€ í™•ì¥

ğŸ“ `backend/app/services/ingestion.py` ìˆ˜ì •:

```python
from app.services.chunker import chunk_text
from app.services.embedding import get_embedding
from app.services.qdrant_client import QdrantDB

def ingest_document(source: str, text: str):
    db = QdrantDB()
    db.create_collection()   # ì»¬ë ‰ì…˜ ì—†ìœ¼ë©´ ìë™ ìƒì„±

    chunks = chunk_text(text)
    points = []

    for idx, chunk in enumerate(chunks):
        embedding = get_embedding(chunk)

        points.append({
            "id": f"{source}-{idx}",
            "vector": embedding,
            "payload": {
                "text": chunk,
                "source": source,
                "chunk_id": idx
            }
        })

    db.upsert_points(points)

    return {
        "message": "Document successfully ingested",
        "chunks": len(chunks)
    }
```

---

# â­ Step 4-3 â€” /ingest APIëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥

ğŸ“ `backend/app/routers/ingest.py`:

```python
from fastapi import APIRouter
from app.models.schemas import IngestRequest
from app.services.ingestion import ingest_document

router = APIRouter()

@router.post("/ingest")
def ingest(req: IngestRequest):
    return ingest_document(req.source, req.text)
```

ì´ì œ `/ingest` ì—”ë“œí¬ì¸íŠ¸ëŠ”:

âœ” chunk ìƒì„±  
âœ” embedding ìƒì„±  
âœ” Qdrant ì €ì¥  
ê¹Œì§€ ëª¨ë‘ ìˆ˜í–‰í•˜ê²Œ ëœë‹¤!

---

# â­ Step 4-4 â€” ê²€ìƒ‰(Search) API ë§Œë“¤ê¸°

ì´ ê¸°ëŠ¥ì€ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ RAG retrievalì˜ í•µì‹¬ì´ê¸° ë•Œë¬¸ì— ì§€ê¸ˆ ë¯¸ë¦¬ ë§Œë“¤ì–´ë‘”ë‹¤.

ğŸ“ `backend/app/routers/search.py` ìƒì„±:

```python
from fastapi import APIRouter
from app.services.embedding import get_embedding
from app.services.qdrant_client import QdrantDB

router = APIRouter()

@router.get("/search")
def search(q: str):
    db = QdrantDB()
    query_vector = get_embedding(q)

    hits = db.search(query_vector)

    results = []
    for h in hits:
        results.append({
            "id": h.id,
            "score": h.score,
            "text": h.payload["text"],
            "source": h.payload["source"]
        })

    return {"results": results}
```

---

# â­ Step 4-5 â€” main.pyì— ì¶”ê°€

ğŸ“ `backend/main.py`

```python
from app.routers import ingest, test_embed, search

app.include_router(ingest.router)
app.include_router(test_embed.router)
app.include_router(search.router)
```

---

# â­ Step 4-6 â€” Docker ì¬ë¹Œë“œ í›„ ì‹¤í–‰

```bash
docker compose down
docker compose up --build -d
```

---

# â­ Step 4-7 â€” end-to-end í…ŒìŠ¤íŠ¸

### 1) ë¬¸ì„œ ì €ì¥í•˜ê¸° (POST /ingest)

ğŸ‘‰ [http://localhost:8000/docs](http://localhost:8000/docs)

JSON:

```json
{
  "source": "test_doc",
  "text": "ì—¬ê¸°ì— ê¸´ ë¬¸ì„œë¥¼ ë„£ìœ¼ì„¸ìš”..."
}
```

ì‘ë‹µ:

```
{
  "message": "Document successfully ingested",
  "chunks": 5
}
```

---

### 2) ê²€ìƒ‰í•´ë³´ê¸° (GET /search?q=AIëŠ”?)

ì˜ˆ:

```
http://localhost:8000/search?q=ë¬¸ì„œê´€ë¦¬
```

ê¸°ëŒ€ ê²°ê³¼:

```
{
  "results": [
    {
      "id": "test_doc-1",
      "score": 0.85,
      "text": "ê²€ìƒ‰ëœ chunk ë‚´ìš©...",
      "source": "test_doc"
    }
  ]
}
```

---

# ğŸ‰ 4ë‹¨ê³„ ì™„ë£Œ ê¸°ì¤€ ì²´í¬ë¦¬ìŠ¤íŠ¸

| í•­ëª©                            | ì„±ê³µ ì—¬ë¶€ |
| ----------------------------- | ----- |
| Qdrant ì»¬ë ‰ì…˜ ìë™ ìƒì„±              | âœ”     |
| chunk + embedding â†’ Qdrant ì €ì¥ | âœ”     |
| ê²€ìƒ‰(search) APIë¡œ ê´€ë ¨ chunk ê²€ìƒ‰   | âœ”     |
| end-to-end ingestion íŒŒì´í”„ë¼ì¸ ì™„ì„± | âœ”     |

---
