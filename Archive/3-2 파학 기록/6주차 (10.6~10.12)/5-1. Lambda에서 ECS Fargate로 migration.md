
- Lambda에서 Crawler를 실행하기 위해서는 Layer에 Chrome 및 Chrome Driver 파일을 추가해야 함
- 추가하는 과정에서 막힘
- ECS Fargate는 컨테이너 기반이기 때문에 함수 기반인 Lambda와 달리 내가 `Dockerfile`로 빌드한 이미지 기반으로 실행 -> 내가 만든 환경 그대로 실행 가능함
- OS, 라이브러리, 환경변수 등과 같은 환경 제어가 가능함

---

### Dockerfile 및 .dockerignore 생성

- Dockerfile
```
FROM mcr.microsoft.com/playwright/python:v1.55.0-jammy

WORKDIR /app

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    AWS_REGION=ap-northeast-2 \
    S3_BUCKET=imfact-news \
    PYTHONPATH=/app

COPY requirements.txt .
RUN pip install --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

COPY . .

RUN playwright install --with-deps chromium

RUN chown -R pwuser:pwuser /app
USER pwuser

CMD ["python", "parser_main.py"]
```

- .dockerignore
```
**/__pycache__
**/.venv
**/.classpath
**/.dockerignore
**/.env
**/.git
**/.gitignore
**/.project
**/.settings
**/.toolstarget
**/.vs
**/.vscode
**/*.*proj.user
**/*.dbmdl
**/*.jfm
**/bin
**/charts
**/docker-compose*
**/compose*
**/Dockerfile*
**/node_modules
**/npm-debug.log
**/obj
**/secrets.dev.yaml
**/values.dev.yaml
LICENSE
README.md

**/*.json
**/*.jsonl
**/*.csv
```

---

### Docker 빌드 및 로컬 실행 테스트

- docker build 명령어
```bash
docker build --platform linux/amd64 -t playwright-news-crawler:dev .
```

- docker run 명령어 (git bash)
```bash
docker run --rm -it \
  --ipc=host \
  --user pwuser \
  -e AWS_REGION=ap-northeast-2 \
  -e S3_BUCKET=imfact-news \
  -v /c/Users/USER/.aws:/home/pwuser/.aws:ro \
  playwright-news-crawlerv:dev
```

- docker run 명령어 (Ubuntu WSL2)
```wsl
docker run --rm -it \
  --ipc=host \
  --user pwuser \
  -e AWS_REGION=ap-northeast-2 \
  -e S3_BUCKET=imfact-news \
  -v ~/.aws:/home/pwuser/.aws:ro \
  playwright-news-crawler:dev

```

---

### ECR 푸시

- ECR 리포지토리 생성
```bash
aws ecr create-repository --repository-name playwright-news-crawler
```

- 파이프를 통해 ECR에 Docker 클라이언트로 로그인
```
aws ecr get-login-password --region ap-northeast-2 | \
docker login --username AWS --password-stdin \
<AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-2.amazonaws.com
```
- 명령어 분석:
	- `aws ecr get-login-password`:
		- Docker 레지스트리 로그인에 필요한 임시 인증 토큰 발급
	- `|`:
		- 파이프(Pipe)를 통해 앞 명령어의 출력(Standard Output)을 뒷 명령어의 입력(Standard Input)으로 연결
	- `docker login`:
		- Docker 클라이언트에게 레지스트리 서버에 로그인하도록 지시
	- `--username AWS`:
		- ECR에 로그인할 때 사용하는 고정된 사용자 이름
	- `--password-stdin`:
		- 비밀번호를 표준 입력(Standard Input)으로부터 읽어 들이도록 지정
	- `<AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-2.amazonaws.com`:
		- 대상 레지스트리 URL

- 태그 붙이기
```bash
docker tag playwright-news-crawler:dev \
<AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-2.amazonaws.com/playwright-news-crawler:dev
```

- ECR 푸시
```
docker push <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-2.amazonaws.com/playwright-news-crawler:dev
```

---

### ECS Task Definition 설정

- `executionRole`, `taskRole` 생성
	- `executionRole`:
		- 기본 실행 역할
		- ECR에서 이미지 가져오기 + CloudWatch Logs 쓰기
	- `taskRole`:
		- 크롤러가 실제 사용할 역할
		- boto3로 S3 업로드

- CloudWatch 로그 그룹 생성

-  json으로 만들면 실수하기 쉬우므로 잘 확인하기
```json
{
    "requiresCompatibilities": [
        "FARGATE"
    ],
    "family": "playwright-news-crawler-task",
    "containerDefinitions": [
        {
            "name": "playwright-news-crawler",
            "image": "567097740956.dkr.ecr.ap-northeast-2.amazonaws.com/playwright-news-crawler:dev",
            "essential": true,
            "entryPoint": ["python", "parser_main.py"],
            "environment": [
                { "name": "AWS_REGION", "value": "ap-northeast-2" },
                { "name": "S3_BUCKET", "value": "imfact-news" }
            ],
            "logConfiguration": {
                "logDriver": "awslogs",
                "options": {
                  "awslogs-group": "/ecs/playwright-news-crawler",
                  "awslogs-region": "ap-northeast-2",
                  "awslogs-stream-prefix": "ecs"
                }
            },
            "user": "pwuser"
        }
    ],
    "networkMode": "awsvpc",
    "memory": "2 GB",
    "cpu": "0.5 vCPU",
    "executionRoleArn": "arn:aws:iam::567097740956:role/ECSTaskExecutionRole",
    "taskRoleArn": "arn:aws:iam::567097740956:role/ImFactCrawlerTaskRole"
}
```

---

### 클러스터에서 태스크 실행

- 태스크 내 로그 확인

---

### EventBridge Rule 생성 명령

```bash
aws events put-rule \
  --name imfact-crawler-daily-rule \
  --schedule-expression "cron(30 8 * * ? *)" \
  --description "Run ImFact Playwright news crawler every day at 8:30 AM KST"
```
