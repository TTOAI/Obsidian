### EC2ì— ì„œë²„ ë°°í¬

- Elastic IP ì£¼ì†Œ: 3.34.56.12
- spring boot ë°°í¬ ì£¼ì†Œ: 3.34.56.12:8080
- Public IPv4 DNS ì£¼ì†Œ: [ec2-3-34-56-12.ap-northeast-2.compute.amazonaws.com](http://ec2-3-34-56-12.ap-northeast-2.compute.amazonaws.com/)

### ì§„í–‰ ìƒí™© ì •ë¦¬

- EC2 ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
- VPC ì„¤ì • - ì¶”ê°€ ê³µë¶€ í•„ìš”
- EC2 ë³´ì•ˆ ê·¸ë£¹ ì„¤ì •
- íƒ„ë ¥ì  IP í• ë‹¹
- Cloud Watch ê²½ë³´ ìƒì„±
- RDS ìƒì„±
- RDS DB ì„œë¸Œë„· ê·¸ë£¹ ì„¤ì •
- RDS ë³´ì•ˆ ê·¸ë£¹ ì„¤ì •
- RDS DB íŒŒë¼ë¯¸í„° ê·¸ë£¹ ì„¤ì •
    - time_zone, charset ì»¤ìŠ¤í„°ë§ˆì´ì§•
- MobaXtermìœ¼ë¡œ EC2ì— SSH ì ‘ì†
- java ì„¤ì¹˜ ë° git clone
- docker ì„¤ì¹˜
- Dockerfile, application-aws-db.yml ìƒì„±
- build
- docker image ìƒì„±
- docker container ìƒì„± ë° ì‹¤í–‰
- í¼ë¸”ë¦­ IP ì£¼ì†Œ:8080ìœ¼ë¡œ ì—°ê²° í…ŒìŠ¤íŠ¸
- nginx ì„¤ì¹˜
- nignx.conf ì„¤ì •
- DNS ì£¼ì†Œë¡œ ì—°ê²° í…ŒìŠ¤íŠ¸

### `feature/awsec2-lee` ë¸Œëœì¹˜ ì£¼ìš” ì»¤ë°‹ ì‚¬í•­

- Dockerfile ìƒì„±í•¨
- application-aws-db.yml ìƒì„±í•¨
- .gitignoreì— application-aws-db.yml ì¶”ê°€
- db.yml ì£¼ì„ ì²˜ë¦¬í•¨ (ec2 ì„œë²„ì— ì•„ì§ MySQLì„ ì„¤ì¹˜í•˜ì§€ ì•ŠìŒ)
- application.yml ë‚´ìš© ë³€ê²½í•¨ (db -> aws-db ë³€ê²½)

### Nginx ì„¤ì • ë° ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì •

1. ì„¤ì¹˜ ë° ì‹œì‘
    
    `sudo amazon-linux-extras install nginx1 -y sudo systemctl start nginx sudo systemctl enable nginx`
    
2. etc/nginx/nginx.conf ë‚´ìš© ì¤‘ server{}ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •
    
    ```
    server {
        listen       80;
        listen       [::]:80;
        server_name  ec2-3-34-56-12.ap-northeast-2.compute.amazonaws.com;
        root         /usr/share/nginx/html;
    
        location / {
                proxy_pass <http://localhost:8080/>;
        }
    
        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;
    
        error_page 404 /404.html;
        location = /404.html {
        }
    
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
        }
    }
    
    ```
    
3. ë¬¸ë²• ê²€ì‚¬
    
    `sudo nginx -t`
    
4. ì„¤ì • ì¬ë¡œë“œ
    
    `sudo systemctl reload nginx` í˜¹ì€ `sudo service nginx reload`
    

### swap ë©”ëª¨ë¦¬ ì„¤ì •

- RAM ìš©ëŸ‰ ë¶€ì¡±ìœ¼ë¡œ buildê°€ ë˜ì§€ ì•ŠëŠ” ìƒí™© ë°œìƒ
- HDDì˜ ì¼ë¶€ë¥¼ RAMì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ swap ë©”ëª¨ë¦¬ ì„¤ì •
- ë©”ëª¨ë¦¬ê°€ ë¶€ì¡±í•  ë•Œ ì„ì‹œë¡œ ë””ìŠ¤í¬ ê³µê°„ì„ í™œìš©í•˜ì—¬ ë©”ëª¨ë¦¬ ë¶€ì¡± ë¬¸ì œ ì™„í™”

1. swap íŒŒì¼ ìƒì„±
    
    `sudo dd if=/dev/zero of=/swapfile bs=128M count=16`
    
2. swap íŒŒì¼ ê¶Œí•œ ì„¤ì •
    
    - root ê¶Œí•œìœ¼ë¡œ ì½ê¸° ë° ì“°ê¸°ë¡œ ì„¤ì •
    
    `sudo chmod 600 /swapfile`
    
3. ìƒì„±í•œ íŒŒì¼ì„ swap ê³µê°„ìœ¼ë¡œ ì´ˆê¸°í™”
    
    `sudo mkswap /swapfile`
    
4. swap í™œì„±í™”
    
    `sudo swapon /swapfile`
    
5. ë¶€íŒ… ì‹œ ìë™ ë§ˆìš´íŠ¸ë¥¼ ìœ„í•œ ì„¤ì •
    
    sudo vi /etc/fstab
    
    - íŒŒì¼ì˜ ëì— ì•„ë˜ì˜ ë‚´ìš© ì¶”ê°€ í›„ ì €ì¥
        
        `/swapfile swap swap defaults 0 0`
        

### ì´ìŠˆ

- CPU ì‚¬ìš©ë¥ ì´ 50%ë¥¼ ë„˜ê¹€ â†’ build ë•Œë¬¸?
    - CPU ì„±ëŠ¥ ì´ìŠˆ â†’ filezilla ì‚¬ìš©í•´ì„œ jar íŒŒì¼ ê³µìœ 
    - RAM ìš©ëŸ‰ ë¶€ì¡± ì´ìŠˆ â†’ swap ë©”ëª¨ë¦¬ ì„¤ì •
- ê³¼ê¸ˆ ë°œìƒ - VPC, RDS, Data transfer
    - 3/11 - $0.01
    - 3/20 - $0.06
    - 3-21 - $0.08

### ë°±ì—”ë“œ ì½”ë“œ ë³€ê²½í•´ì•¼ í•  ì‚¬í•­

### Dockerfile

- `-Dspirng.profiles.active-oauth,aws-db`ë¥¼ ì–´ë–»ê²Œ ë°”ê¿€ì§€ ìƒê°í•˜ê¸°

### ê°œë°œìš© DB

- ec2 ì„œë²„ì—ë„ MySQLì„ ê°œë°œìš©ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°
- ì„¤ì •íŒŒì¼(application-dev.yml ë“± ìƒì„±â€¦) ì–´ë–»ê²Œ ì„¤ì •í•´ì•¼ í• ì§€ ìƒê°í•˜ê¸°

### í…ŒìŠ¤íŠ¸ìš© DB

- h2 í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ì„¤ì¹˜ ê³ ë ¤

### ì„¤ì •íŒŒì¼

- awsê¹Œì§€ ê³ ë ¤í•´ì„œ ì„¤ì •íŒŒì¼ êµ¬ì„± ë°”ê¾¸ê¸°

### ìë™ ë°°í¬

- build -> docker image ë§Œë“¤ê¸° -> docker container ë§Œë“¤ê¸° -> container ì‹¤í–‰
- ìœ„ì˜ ê³¼ì •ì´ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •í•˜ê¸°

### Docker container ë„ìš°ëŠ”ë²•

```java
# 1) í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ëª¨ë“  ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
docker stop $(docker ps -q)
docker rm $(docker ps -aq)

# 2) í”„ë¡œì íŠ¸ ë””ë ‰í„°ë¦¬ ì´ë™
cd ~/onRank/onRank-spring

# 2.5) git pull
git pull

# 3) ê¸°ì¡´ ë¹Œë“œ í´ë” ì‚­ì œ ë° ìƒˆ ë¹Œë“œ
rm -rf build
./gradlew build

# 4) ìƒˆ Docker ì´ë¯¸ì§€ ë¹Œë“œ
docker build -t onrank-api:v2.0 .

# 5) Docker Hubì— í‘¸ì‹œí•  íƒœê·¸ë¡œ íƒœê¹…(ì›í•˜ëŠ” ê²½ìš°)
docker tag onrank-api:v2.0 onrank/onrank-api:v2.0

# 6) ì»¨í…Œì´ë„ˆ ì‹¤í–‰
docker run -d -p 8080:8080 onrank/onrank-api:v2.0

```

### Gitì— ë¯¼ê° ì •ë³´ë¥¼ ì»¤ë°‹í–ˆì„ ë•Œ ëŒ€ì²˜ë²•

[https://dog-foot-story.tistory.com/entry/git-ì†ŒìŠ¤ì—-ë¯¼ê°-ì •ë³´-ì˜¬ë¼ê°”ì„-ë•Œ-ì¡°ì¹˜-ë°©ë²•-íŠ¹ì •-ì»¤ë°‹ë§Œ-ì‚­ì œí•˜ê³ -ì‹¶ì„-ë•Œ](https://dog-foot-story.tistory.com/entry/git-%EC%86%8C%EC%8A%A4%EC%97%90-%EB%AF%BC%EA%B0%90-%EC%A0%95%EB%B3%B4-%EC%98%AC%EB%9D%BC%EA%B0%94%EC%9D%84-%EB%95%8C-%EC%A1%B0%EC%B9%98-%EB%B0%A9%EB%B2%95-%ED%8A%B9%EC%A0%95-%EC%BB%A4%EB%B0%8B%EB%A7%8C-%EC%82%AD%EC%A0%9C%ED%95%98%EA%B3%A0-%EC%8B%B6%EC%9D%84-%EB%95%8C)

1. ìµœê·¼ ì„¸ ê°œ ì»¤ë°‹ ìˆ˜ì •

```java
git rebase -i HEAD~3
```

1. ì²« ë²ˆì§¸ ì»¤ë°‹ pickì—ì„œ editìœ¼ë¡œ ìˆ˜ì •

```java
pick 5a8c173 ì»¤ë°‹
pick adde6f9 ë‚´ìš©
pick 01ad706 ì»¤ë°‹ë‚´ìš©
```

1. ì €ì¥í•˜ê³  ë‹«ê¸°

```java
edit 5a8c173 ì»¤ë°‹
```

1. ë¯¼ê° íŒŒì¼ Git ì¸ë±ìŠ¤ì—ì„œ ì œê±°

```java
git rm --cached <ë¯¼ê° íŒŒì¼>
```

1. ìˆ˜ì •ëœ ì»¤ë°‹ìœ¼ë¡œ ì´ì–´ê°€ê¸°

```java
git commit --amend
```

1. rebase ì´ì–´ê°€ê¸°

```java
git rebase --continue
```

1. ê°•ì œ í‘¸ì‹œ

```java
git push origin <ë¸Œëœì¹˜ëª…> --force
```

### API ìµœê·¼ ë³€ê²½ ì‚¬í•­

study ìƒì„± api ê²½ë¡œ, ìŠ¤í„°ë”” ë©¤ë²„ ì¶”ê°€ api ê²½ë¡œì—ì„œ /add ì œê±° -> post ë©”ì†Œë“œ ìì²´ì— ìƒì„±ì˜ ì˜ë¯¸ê°€ ìˆìŒ

(ì°¸ê³ ) study ìƒì„±, ìŠ¤í„°ë”” ë©¤ë²„ ì¶”ê°€ì™€ ê°™ì€ post methodì˜ http ì‘ë‹µì€ 201 createdì™€ í•¨ê»˜ headerì— "Location": <ìƒì„±ëœ ë¦¬ì†ŒìŠ¤ì˜ URI>ê°€ í¬í•¨ë˜ë„ë¡ ë³€ê²½ ex) "Location": "/studies/{studyId}"

### OpenAPI ì ìš©

[onrank.kr/swagger-ui.html](http://onrank.kr/swagger-ui.html) ë˜ëŠ” [onrank.kr/swagger-ui/index.html](http://onrank.kr/swagger-ui/index.html)

### ì•ˆì „í•˜ê²Œ Git í˜‘ì—…í•˜ê¸°

### ì‘ì—… ì „

```java
	# ì›ê²© ìƒíƒœ ë™ê¸°í™”
git remote update

# ì‘ì—…í•  ë¸Œëœì¹˜ë¡œ ì´ë™

## -b ì œì™¸: ë¡œì»¬ì— ì—†ì§€ë§Œ ì›ê²©ì— ë™ì¼í•œ ì´ë¦„ì˜ ë¸Œëœì¹˜ê°€ ìˆëŠ” ê²½ìš° ìë™ ì¶”ì  ì„¤ì •
git checkout <ì‘ì—…í•  ë¸Œëœì¹˜>

## -b í¬í•¨: ë¡œì»¬ì— ì—†ëŠ” ìƒˆë¡œìš´ ë¸Œëœì¹˜ ìƒì„± (ìë™ ì¶”ì  ì„¤ì •ë˜ì§€ ì•ŠìŒ)
## í˜„ì¬ ë¸Œëœì¹˜ì˜ ì½”ë“œ ìƒíƒœì™€ ì»¤ë°‹ íˆìŠ¤í† ë¦¬ë¥¼ ê·¸ëŒ€ë¡œ ì´ì–´ë°›ìŒ
git checkout -b <ì‘ì—…í•  ë¸Œëœì¹˜>

# ì›ê²©ì˜ ë³€ê²½ì‚¬í•­ì„ ë¡œì»¬ ë¸Œëœì¹˜ì— ë°˜ì˜
## git fetch + git merge ë˜ëŠ” git fetch + git rebaseë¥¼ í•œ ë²ˆì— ìˆ˜í–‰
git pull
```

### ì•ˆì „í•˜ê²Œ ì›ê²© ì €ì¥ì†Œì˜ ë³€ê²½ ì‚¬í•­ ë¹„êµ

```java
# ì›ê²© ë¸Œëœì¹˜ ëª©ë¡ í™•ì¸
git branch -r

# íŠ¹ì • ë¸Œëœì¹˜ì˜ ì»¤ë°‹ ë¡œê·¸ í™•ì¸
git log origin/main --oneline

# ë³€ê²½ì‚¬í•­ ë¹„êµ ë° ê²€í† 

## í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë¡œì»¬ ë¸Œëœì¹˜ì™€ ì›ê²© ë¸Œëœì¹˜ ì°¨ì´ ë¹„êµ
git diff HEAD origin/main

## ë¡œì»¬ì— ì—†ëŠ” ì›ê²© ì»¤ë°‹ë“¤ì„ í™•ì¸
git log HEAD..origin/main --oneline

# ì›ê²© ì—…ë°ì´íŠ¸ í›„ ë³‘í•©
git merge origin/main
```

### ì‘ì—… í›„

```java
# í‘¸ì‰¬í•˜ë©´ì„œ ë¡œì»¬ ë¸Œëœì¹˜ì˜ ì¶”ì  ëŒ€ìƒì„ ìë™ìœ¼ë¡œ ì„¤ì •
git push -u origin feature
```

### IDEì—ì„œ ë¸Œëœì¹˜ mergeí•˜ê¸°

```java
# merge ì˜ˆì‹œ(mainë¸Œëœì¹˜ì™€ feature ë¸Œëœì¹˜ ì˜ˆì‹œ)
# feature:         D --- E
#                 /       \\
# main:    A --- B --- C --- M   (M: merge ì»¤ë°‹)

# merge ì»¤ë°‹ Mì„ ìƒì„±í•˜ê³ ì í•˜ëŠ” ë¸Œëœì¹˜ë¡œ ì´ë™
git checkout main

# feature ë¸Œëœì¹˜ì˜ ë³€ê²½ì‚¬í•­ì„ main ë¸Œëœì¹˜ì— merge
git merge feature

# ì»¤ë°‹ ê·¸ë˜í”„ í™•ì¸
git log --oneline --graph --all

# ì‘ì—… í›„ì—ëŠ” í‘¸ì‰¬
```

### ì „ì—­ ì˜ˆì™¸ ì²˜ë¦¬

- ì•„ë˜ëŠ” ChatGPT ê¸°ë°˜ ì „ì—­ì˜ˆì™¸ì²˜ë¦¬ ì˜ˆì‹œ íë¦„
    
- íë¦„ì„ ë³´ê³  ë¸”ë¡œê·¸ ì°¸ê³  ë° êµ¬ê¸€ë§ì„ í†µí•´ ë‹¤ì‹œ ê³µë¶€
    
- Spring ì˜ˆì™¸ ì²˜ë¦¬ íë¦„
    
    ```json
    [ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìˆ˜í–‰ ì¤‘]
           â”‚
           â–¼
    [ì¡°ê±´ ê²€ì‚¬] â”€â”€â”€â”€â”€â”€â–¶ (ì¡°ê±´ ìœ„ë°˜)
           â”‚               â”‚
           â–¼               â–¼
    [ì •ìƒ ì²˜ë¦¬]        throw new ì˜ˆì™¸ê°ì²´
           â”‚               â”‚
           â–¼               â–¼
    [Controller ë¦¬í„´]   ì˜ˆì™¸ ë°œìƒ (Exception ì „íŒŒ)
                              â”‚
                              â–¼
                Spring DispatcherServlet
                              â”‚
                              â–¼
             @RestControllerAdvice í™•ì¸
                              â”‚
                              â–¼
         @ExceptionHandler(ì˜ˆì™¸ íƒ€ì…) ì¡´ì¬?
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                          â”‚
             [ìˆìŒ]                     [ì—†ìŒ]
                â”‚                          â”‚
                â–¼                          â–¼
    [í•´ë‹¹ ë©”ì„œë“œë¡œ ìœ„ì„]         ê¸°ë³¸ ì—ëŸ¬ ì²˜ë¦¬(JSON or HTML)
                â”‚
                â–¼
     ResponseEntity<ErrorResponse> ìƒì„±
                â”‚
                â–¼
        í´ë¼ì´ì–¸íŠ¸ì— JSON ì‘ë‹µ ë°˜í™˜
    ```
    
- ì „ì—­ì˜ˆì™¸ì²˜ë¦¬ í…œí”Œë¦¿ êµ¬ì„±
    
    ```java
    com.onrank.server
    â”œâ”€â”€ global
    â”‚   â””â”€â”€ exception
    â”‚       â”œâ”€â”€ GlobalExceptionHandler.java   â† ì „ì—­ ì˜ˆì™¸ ì²˜ë¦¬
    â”‚       â”œâ”€â”€ ErrorCode.java                â† ì—ëŸ¬ ì½”ë“œ ì •ì˜
    â”‚       â”œâ”€â”€ ErrorResponse.java            â† ì—ëŸ¬ ì‘ë‹µ í¬ë§·
    â”‚       â””â”€â”€ BusinessException.java        â† ê³µí†µ ì»¤ìŠ¤í…€ ì˜ˆì™¸ (ìƒì†ìš©)
    â””â”€â”€ ...
    ```
    
    - ì˜ˆì™¸ ë°œìƒ ì½”ë“œ (`throw new ì˜ˆì™¸ê°ì²´`) ì˜ˆì‹œì½”ë“œ
        
        ```java
        if (!memberService.isMemberCreatorOrHost(...)) {
            throw new BusinessException(ErrorCode.FORBIDDEN);
        }
        ```
        
    - ì»¤ìŠ¤í…€ ì˜ˆì™¸ í´ë˜ìŠ¤ (`BusinessException`) ì˜ˆì‹œ ì½”ë“œ
        
        ```java
        @Getter
        public class BusinessException extends RuntimeException {
        
            private final ErrorCode errorCode;
        
            public BusinessException(ErrorCode errorCode) {
                super(errorCode.getMessage());
                this.errorCode = errorCode;
            }
        }
        ```
        
    - ì—ëŸ¬ ì½”ë“œ ì •ì˜ í´ë˜ìŠ¤ (`ErrorCode`) ì˜ˆì‹œ ì½”ë“œ
        
        ```java
        package com.onrank.server.global.exception;
        
        import lombok.Getter;
        import lombok.RequiredArgsConstructor;
        import org.springframework.http.HttpStatus;
        
        @Getter
        @RequiredArgsConstructor
        public enum ErrorCode {
        
            // ğŸ”¸ 400 Bad Request
            INVALID_INPUT_VALUE(HttpStatus.BAD_REQUEST, "ì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤."),
            MISSING_REQUIRED_PARAMETER(HttpStatus.BAD_REQUEST, "í•„ìˆ˜ íŒŒë¼ë¯¸í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤."),
        
            // ğŸ”¸ 401 Unauthorized
            UNAUTHORIZED(HttpStatus.UNAUTHORIZED, "ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤."),
        
            // ğŸ”¸ 403 Forbidden
            FORBIDDEN(HttpStatus.FORBIDDEN, "ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."),
        
            // ğŸ”¸ 404 Not Found
            ENTITY_NOT_FOUND(HttpStatus.NOT_FOUND, "ìš”ì²­í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."),
            USER_NOT_FOUND(HttpStatus.NOT_FOUND, "í•´ë‹¹ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."),
        
            // ğŸ”¸ 409 Conflict
            DUPLICATE_RESOURCE(HttpStatus.CONFLICT, "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë¦¬ì†ŒìŠ¤ì…ë‹ˆë‹¤."),
        
            // ğŸ”¸ 500 Internal Server Error
            INTERNAL_SERVER_ERROR(HttpStatus.INTERNAL_SERVER_ERROR, "ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        
            private final HttpStatus status;
            private final String message;
        }
        
        ```
        
    - ì „ì—­ì˜ˆì™¸ì²˜ë¦¬ í´ë˜ìŠ¤ (`GlobalExceptionHandler`, `@RestControllerAdvice`, `@ExceptionHandler`) ì˜ˆì‹œ ì½”ë“œ
        
        ```java
        @RestControllerAdvice
        public class GlobalExceptionHandler {
        
            @ExceptionHandler(ForbiddenException.class)
            public ResponseEntity<ErrorResponse> handleForbidden(ForbiddenException e, HttpServletRequest request) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN)
                        .body(ErrorResponse.of(ErrorCode.FORBIDDEN, request.getRequestURI()));
            }
        
            @ExceptionHandler(NotFoundException.class)
            public ResponseEntity<ErrorResponse> handleNotFound(NotFoundException e, HttpServletRequest request) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND)
                        .body(ErrorResponse.of(ErrorCode.NOT_FOUND, request.getRequestURI()));
            }
            
            // ì»¤ìŠ¤í…€ ì˜ˆì™¸ í´ë˜ìŠ¤
            @ExceptionHandler(BusinessException.class)
        		public ResponseEntity<ErrorResponse> handleBusiness(BusinessException e, HttpServletRequest request) {
        		    return ResponseEntity.status(e.getErrorCode().getStatus())
        		            .body(ErrorResponse.of(e.getErrorCode(), request.getRequestURI()));
        		}
        
            @ExceptionHandler(Exception.class)
            public ResponseEntity<ErrorResponse> handleAll(Exception e, HttpServletRequest request) {
                return ResponseEntity.status(ErrorCode.INTERNAL_SERVER_ERROR.getStatus())
                        .body(ErrorResponse.of(ErrorCode.INTERNAL_SERVER_ERROR, request.getRequestURI()));
            }
        }
        ```
        
    - ì—ëŸ¬ ì‘ë‹µ í¬ë§· í´ë˜ìŠ¤ (`ErrorResponse`) ì˜ˆì‹œ ì½”ë“œ
        
        ```java
        @Getter
        @AllArgsConstructor
        public class ErrorResponse {
        
            private final int status;
            private final String code;
            private final String message;
            private final String path;
            private final LocalDateTime timestamp;
        
            public static ErrorResponse of(ErrorCode errorCode, String path) {
                return new ErrorResponse(
                        errorCode.getStatus().value(),
                        errorCode.name(),
                        errorCode.getMessage(),
                        path,
                        LocalDateTime.now()
                );
            }
        }
        ```
        

### ê³¼ì œ API ê°œë°œ

- FileMetadataResponse
    - recordë¡œ ë§Œë“¦ â†’ ì–´ë…¸í…Œì´ì…˜ì„ ì“°ì§€ ì•Šì•„ë„ ë˜ê³ , ì½”ë“œê°€ ì¡°ê¸ˆ ë” ì‹¬í”Œí•´ì§
- @Transactional(readOnly = true)
    - ëª¨ë“  ë©”ì†Œë“œê°€ ì½ê¸° ì „ìš©ì¸ Serivce í´ë˜ìŠ¤ê°€ ì•„ë‹ˆë©´ ë©”ì†Œë“œë³„ë¡œ ì„ ì–¸í•˜ì
- @Builder
    - @Builderë¥¼ ì“°ë©´ ì—°ê´€ê´€ê³„ ë§¤í•‘ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤
    - ì—”í‹°í‹°ë¥¼ ìƒì„±í•  ë•Œ ì—°ê´€ê´€ê³„ ë§¤í•‘ì„ í•œ ê²½ìš°ëŠ” í˜„ì¬ member ì—”í‹°í‹° ë°–ì— ì—†ë‹¤
    - ì—°ê´€ê´€ê³„ ë§¤í•‘ì„ í•˜ë©´ @Builder ì• ë…¸í…Œì´ì…˜ì´ êµ³ì´ í•„ìš”í•˜ì§€ ì•Šë‹¤
    - ë‹¤ë¥¸ ì—”í‹°í‹° í´ë˜ìŠ¤ë“¤ë„ @Builderë¥¼ ì§€ìš°ê³  ì—°ê´€ê´€ê³„ ë§¤í•‘ì„ í•˜ì

---

---

- application.ymlì— ì•„ë˜ ë‚´ìš© ì¶”ê°€
    
    ```yaml
    // Nginx ë’¤ì—ì„œ Spring Bootê°€ ì‹¤í–‰ë˜ê³  ìˆë‹¤ë©´, 
    // Springì€ ì´ë¥¼ HTTP ìš”ì²­ìœ¼ë¡œ ì˜¤í•´í•  ìˆ˜ ìˆìŒ.
    
    // ë”°ë¼ì„œ ì•„ë˜ì˜ ì„¤ì •ì„ í†µí•´
    // Nginxê°€ ê¸°ë³¸ì ìœ¼ë¡œ X-Forwarded-* í—¤ë”ë¥¼ ì „ë‹¬í•˜ë„ë¡ í•¨
    // ì´ ì„¤ì •ì„ í†µí•´ Spring Bootê°€ ê·¸ëŸ° í”„ë¡ì‹œ í—¤ë”ë¥¼ ì‹ ë¢°í•˜ê³ 
    // ì‹¤ì œ ìš”ì²­ì˜ í”„ë¡œí† ì½œ, í˜¸ìŠ¤íŠ¸ ë“±ì„ ì œëŒ€ë¡œ ì¸ì‹í•˜ë„ë¡ ë§Œë“¦.
    
    server:
      forward-headers-strategy: framework
    ```
    

---

---

- `IllegalAccessException`ìœ¼ë¡œ Service ë‹¨ì—ì„œ ì˜ˆì™¸ ì²˜ë¦¬
    
    ```java
        public ContextResponse<List<SubmissionListResponse>> getSubmissions(
                String username,
                Long studyId,
                Long assignmentId) throws IllegalAccessException {
    
            // CREATOR, HOST ë§Œ ê°€ëŠ¥
            if (!memberService.isMemberCreatorOrHost(username, studyId)) {
                throw new IllegalAccessException("Creator, Hostë§Œ ì ‘ê·¼ ê°€ëŠ¥");
            }
            .
            .
            .
    ```
    
    - controller í´ë˜ìŠ¤ì—ì„œ try-catchë¡œ Exception í•¸ë“¤ë§
    - ë‚˜ì¤‘ì— ì»¤ìŠ¤í…€ `Exception`ê³¼ `GlobalExceptionHandler` êµ¬í˜„ í›„ `IllegalAccessException` ë¶€ë¶„ ìˆ˜ì •

### ìë™ ë°°í¬ ì„¤ì •

- SSH í‚¤ ìƒì„±
    
    ```bash
    ssh-keygen -t rsa -b 4096 -C "github-actions" -f ./github-actions-key
    ```
    
    - `github-actions-key`: ê°œì¸ í‚¤ (GitHub Secretsì— ë“±ë¡)
    - `github-actions-key.pub`: ê³µê°œ í‚¤ (EC2ì— ë“±ë¡)
- EC2ì— ê³µê°œ í‚¤ ë“±ë¡
    
- GitHub `Secrets` ë“±ë¡
    
    - `GitHub í”„ë¡œì íŠ¸` > `Settings` > `Secrets` > `Actions`
    - `EC2_HOST`: EC2 í¼ë¸”ë¦­ IP ë˜ëŠ” ë„ë©”ì¸
    - `EC2_USER`: ë³´í†µ ubuntu ë˜ëŠ” ec2-user
    - `EC2_KEY`: SSH ê°œì¸ í‚¤
- GitHub Actions ì›Œí¬í”Œë¡œìš° ì‘ì„±
    
    - í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì— .github/workflows/deploy.yml íŒŒì¼ ìƒì„±
        
        ```bash
        name: Deploy to EC2
        
        on:
          push:
            branches: [ "develop" ]  # develop ë¸Œëœì¹˜ì— pushë  ë•Œ ìë™ ë°°í¬
        
        jobs:
          deploy:
            runs-on: ubuntu-latest
        
            steps:
              - name: Checkout source code
                uses: actions/checkout@v3
        
              - name: Generate Docker image tag from Git commit
                id: vars
                run: echo "TAG=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
        
              - name: Deploy via SSH
                uses: appleboy/ssh-action@v1.0.0
                with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_KEY }}
                  script: |
                    echo "[1] ì´ë™: í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ"
                    cd /home/ec2-user/onRank/onRank-spring
        
                    echo "[2] Git ìµœì‹ í™” (ë¸Œëœì¹˜ ê°•ì œ ì§€ì •)"
                    git fetch origin
                    git checkout develop
                    git reset --hard origin/develop
        
                    echo "[3] ê¸°ì¡´ Docker ì»¨í…Œì´ë„ˆ ì •ë¦¬"
                    docker stop onrank-api || true
                    docker rm onrank-api || true
        
                    echo "[4] Gradle ë¹Œë“œ (ê¸°ì¡´ íŒŒì¼ ì •ë¦¬ í›„ ì¬ë¹Œë“œ)"
                    ./gradlew clean build -x test
        
                    echo "[5] Docker ì´ë¯¸ì§€ ë¹Œë“œ (íƒœê·¸: ${{ env.TAG }})"
                    docker build -t onrank-api:${{ env.TAG }} .
        
                    echo "[6] Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ìë™ ì¬ì‹œì‘ ì„¤ì •)"
                    docker run -d \\
                      --name onrank-api \\
                      --restart unless-stopped \\
                      -p 8080:8080 \\
                      onrank-api:${{ env.TAG }}
        ```
        
- ì¶”ê°€ ê°œë°œ ì‚¬í•­
    
    - GitHub Actionsì—ì„œ **Self-Hosted Runner**ë¥¼ EC2 ë‚´ë¶€ì— ì„¤ì¹˜
        - EC2 â†’ EC2 ë‚´ë¶€ë‹ˆê¹Œ SSH ì—°ê²° í•„ìš” ì—†ìŒ (í˜„ì¬ SSH ê°€ ëª¨ë“  IP ì£¼ì†Œì— ì—´ë ¤ ìˆìŒ)
        - GitHub ì„œë²„ë³´ë‹¤ ë¡œì»¬ ë¹Œë“œ ì†ë„ ë¹ ë¥¼ ìˆ˜ ìˆìŒ
        - GitHub ë¬´ë£Œ ìš”ê¸ˆì œì—ì„œëŠ” Actions ì‹¤í–‰ ì‹œê°„ì— ì œí•œì´ ìˆëŠ”ë°, Self-HostedëŠ” ì œí•œ ì—†ìŒ
        - Docker, Java, Node ë“± ì‚¬ì „ ì„¤ì¹˜ ê°€ëŠ¥. ë¹Œë“œ í™˜ê²½ ì œì–´ ê°€ëŠ¥
    - **IAM Role + CodeDeploy** ê°™ì€ AWS ê³µì‹ ë°°í¬ ì„œë¹„ìŠ¤ ì‚¬ìš©
    - docker-compose ì ìš©
    - Secrets ë˜ëŠ” .env ì„¤ì •
    - docker-composeë¡œ prod/dev ë”°ë¡œ ê´€ë¦¬

### Git í˜‘ì—… ver.2

- `feature/abcd` ë¸Œëœì¹˜ì—ì„œ ì‘ì—…
- ì‘ì—…ì´ ëë‚˜ë©´ `develop`ì— merge
- ì´í›„ ë‹¤ì‹œ `feature/abcd`ë¡œ ì‘ì—…
- í•˜ì§€ë§Œ ê·¸ ì‚¬ì´ì— `develop`ì€ ë‹¤ë¥¸ ì‚¬ëŒë“¤ì˜ ì½”ë“œë¡œ ê³„ì† ë°”ë€œ
- `feature/abcd`ê°€ `develop`ë³´ë‹¤ ë’¤ì²˜ì§€ê³ , ë‹¤ì‹œ mergeí•´ì•¼ í•˜ëŠ” ìƒí™© ë°˜ë³µ

|ì‘ì—… íƒ€ì´ë°|ìˆ˜í–‰í•  Git ëª…ë ¹ì–´|
|---|---|
|ìƒˆ ì‘ì—… ì „|`git checkout feature/abcd|
|git pull||
|git fetch origin||
|git status||
|git merge origin/develop`||
|ì‘ì—… ì™„ë£Œ í›„|`git commit -m "ì‘ì—… ë‚´ìš©"`|
|ë³‘í•© ì‹œ|`git checkout develop|
|git pull||
|git merge feature/abcd||
|git push`||
|ë‹¤ìŒ ì‘ì—… ì „|ìœ„ ë£¨í‹´ ë°˜ë³µ|

### SwaggerConfig

- ìš°í•™ë™ ì°¸ê³ í•´ì„œ ë§Œë“¤ê¸°

### ë¡œê·¸ì¸ êµ¬í˜„

### **ê°œë°œ í™˜ê²½ì— ë”°ë¥¸ ë¡œê·¸ì¸ êµ¬í˜„ ë°©ì‹ì˜ ì°¨ì´**

## SSR í™˜ê²½

- ì„¸ì…˜ ì¿ í‚¤ ë°©ì‹ì´ ë§ì´ ì‚¬ìš©ë¨

## SPA(CSR) í™˜ê²½

- HTTP í—¤ë” ë°©ì‹ + Bearer í† í°/JWT ì¸ì¦ or API í‚¤ ê¸°ë°˜ ì¸ì¦
- ì¶”ê°€ì ìœ¼ë¡œ SPA ë°©ì‹ì€ ë³´í†µ RESTful APIë‚˜ GraphQLì„ í†µí•´ ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ìŒ

### **ë¡œê·¸ì¸ êµ¬í˜„ ë°©ì‹**

ë³´ì•ˆ ê´€ë ¨ í‚¤ì›Œë“œ: CORS ì •ì±…, CSRF, XSS

## ì„¸ì…˜ ë°©ì‹

### ì„¸ë¶€ í”„ë¡œì„¸ìŠ¤ ë° êµ¬í˜„ ë°©ì‹

- ë³´í†µ ì„¸ì…˜IDë¥¼ ì¿ í‚¤ì— ì €ì¥í•˜ê³  ì „ë‹¬í•˜ëŠ” ì¿ í‚¤ ë°©ì‹ì„ í•¨ê»˜ ì‚¬ìš©í•¨

### íŠ¹ì§•

### ì¥ì 

### ë‹¨ì 

- ì„¸ì…˜ID ì¦‰ì‹œ ë¬´íš¨í™” ê°€ëŠ¥

### ì¿ í‚¤ ì‚¬ìš©ì— ë”°ë¥¸ ë³´ì•ˆ ìœ„í˜‘ ì¸¡ë©´

- XSS ê³µê²© -> HTTP-Only, Secure, SameSite ì„¤ì •

### ë³´ì•ˆì„ ìœ„í•œ ë°©ì•ˆ

- HTTPS êµ¬ì¶•

---

## í† í° ë°©ì‹

### ì„¸ë¶€ í”„ë¡œì„¸ìŠ¤ ë° êµ¬í˜„ ë°©ì‹

- access tokenì€ ë³´í†µ HTTP í—¤ë”ë¡œ ì „ë‹¬ í›„ ë¸Œë¼ìš°ì €ì˜ LocalStorageì— ì €ì¥
    - ì „ë‹¬í•  ë•ŒëŠ” "Authorization: Bearer token" í˜•ì‹ìœ¼ë¡œ ì „ë‹¬
- refresh tokenì€ ë³´í†µ ì¿ í‚¤ë¡œ ì „ë‹¬ í›„ CookieStorageì— ì €ì¥
- access token ì¬ë°œê¸‰ì—ì„œ refresh tokenë„ ê°™ì´ ì¬ë°œê¸‰ -> RTR
- refresh token ë°œê¸‰ ë°©ì‹
    - JWT: access tokenì„ ë°œê¸‰í•  í•„ìš”í•œ ì •ë³´ë¥¼ claimì— ì €ì¥ ê°€ëŠ¥
    - UUID: ë°œê¸‰ê³¼ ì‚­ì œê°€ ì‰¬ì›€

### íŠ¹ì§•

- í´ë ˆì„:
- í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œë„ í† í°ì„ íŒŒì‹±í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ
    - í† í°ì˜ í´ë ˆì„ ì •ë³´(ì—­í• , ê¶Œí•œ, ë§Œë£Œ ì‹œê°„ ë“±)ë¥¼ í™•ì¸í•˜ì—¬ ì‚¬ìš©ì ë³„ë¡œ ë§ì¶¤ UI ì œê³µ ê°€ëŠ¥
    - í•˜ì§€ë§Œ ë³´ì•ˆìƒì˜ ì´ìœ ë¡œ ìµœì¢… ê²€ì¦ì€ ì„œë²„ì—ì„œ ì´ë£¨ì–´ì ¸ì•¼ í•¨

### ì¥ì 

- ì¿ í‚¤ í™œìš©ì´ ì–´ë ¤ìš´ ì•±ê°œë°œ í™˜ê²½ì—ì„œ ìœ ë¦¬í•¨

### ë‹¨ì 

- í† í° ì¦‰ì‹œ ë¬´íš¨í™” ë¶ˆê°€ëŠ¥

### HTTP í—¤ë” ì‚¬ìš©ì— ë”°ë¥¸ ë³´ì•ˆ ìœ„í˜‘ ì¸¡ë©´

### ë³´ì•ˆì„ ìœ„í•œ ë°©ì•ˆ

- XSSì— ëŒ€ë¹„í•˜ê¸° ìœ„í•´ì„œ Access í† í°ì˜ ìƒëª… ì£¼ê¸°ë¥¼ ì§§ê²Œ í•˜ê³  Refresh ë„ì…
- XSS ë°©ì–´ë¥¼ ìœ„í•´ Refresh tokenì€ ì¿ í‚¤ì— ì €ì¥
- Refresh í† í°ì„ ì €ì¥í•˜ëŠ” ì¿ í‚¤ì—ëŠ” `httpOnly`ì™€ `Secure` ì˜µì…˜ì„ ì„¤ì •í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ ì¸¡ ìŠ¤í¬ë¦½íŠ¸ë¡œë¶€í„° ì ‘ê·¼ì„ ì°¨ë‹¨
- Refresh tokenì˜ ê²½ìš° íŠ¹ì • ìƒí™©ì—ë§Œ ì‚¬ìš©í•˜ë¯€ë¡œ CSRFì— ëŒ€í•œ í° ë³´ì•ˆ ìœ„í˜‘ ê°€ëŠ¥ì„±ì´ ì ìŒ
- ì—ë””í„°ë‹¨ì—ì„œ JS ì„ë² ë“œ ë°©ì–´

---

## í¼ ë¡œê·¸ì¸ ë°©ì‹

---

## HTTP Basic ë°©ì‹

---

## OAuth2 ë¡œê·¸ì¸ ë°©ì‹

- ì „í†µì ì¸ API í˜¸ì¶œ ë°©ì‹(axios, fetch) ëŒ€ì‹  ë¸Œë¼ìš°ì €ì˜ ë¦¬ë‹¤ì´ë ‰ì…˜(location.href ë“±)ì„ ì‚¬ìš©í•˜ëŠ” êµ¬ì¡°ë¡œ ì„¤ê³„
    - API í´ë¼ì´ì–¸íŠ¸ë¥¼ ì‚¬ìš©í•˜ë©´ CORS ì •ì±…ì— ì˜í•´ ì™¸ë¶€ ë„ë©”ì¸ì— ìš”ì²­ì„ ë³´ë‚´ëŠ” ë° ì œì•½ì´ ë°œìƒí•  ìˆ˜ ìˆìŒ
    - ë¸Œë¼ìš°ì € ì „ì²´ë¥¼ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ì—¬ ì™¸ë¶€ ë„ë©”ì¸ê³¼ì˜ ìƒí˜¸ì‘ìš©ì„ ê°€ëŠ¥í•˜ê²Œ í•¨
    - OAuth2 ë¡œê·¸ì¸ ê³¼ì •ì—ì„œëŠ” ì‚¬ìš©ìê°€ ì¸ì¦ ì •ë³´ ì…ë ¥ ë° ë™ì˜ ì ˆì°¨ë¥¼ ê±°ì¹˜ê²Œ ë˜ëŠ”ë°, ì´ëŠ” ì „ìš© ë¡œê·¸ì¸ í˜ì´ì§€ë¥¼ í†µí•´ ì´ë£¨ì–´ë¯€ë¡œ ì‚¬ìš©ìê°€ ì§ì ‘ í•´ë‹¹ í˜ì´ì§€ë¡œ ì´ë™í•´ì•¼ í•¨

---

## í† í° ë°©ì‹ + OAuth2 ë¡œê·¸ì¸ ë°©ì‹ì—ì„œì˜ ë¬¸ì œì 

- ì°¸ê³ 1 ![[Pasted image 20250223010609.png]]
- ì°¸ê³ 2 ![[Pasted image 20250223010635.png]] ![[Pasted image 20250223024730.png]] [https://www.youtube.com/watch?v=s6D_zXnrXNo&list=PLJkjrxxiBSFALedMwcqDw_BPaJ3qqbWeB&index=13](https://www.youtube.com/watch?v=s6D_zXnrXNo&list=PLJkjrxxiBSFALedMwcqDw_BPaJ3qqbWeB&index=13)
- OAuth2 ë¡œê·¸ì¸ì˜ ê²½ìš° ë™ì‘ íŠ¹ì„±ìƒ hrefë¡œ ìš”ì²­í•˜ê¸° ë•Œë¬¸ì— ë¬´ì¡°ê±´ ì¿ í‚¤ë¡œ ì‘ë‹µí•´ì•¼ í•¨
- ë¡œê·¸ì¸ ì„±ê³µ í›„ ë°±ì—”ë“œì—ì„œ í”„ë¡ íŠ¸ì—”ë“œë¡œ í† í°ì„ ë„˜ê²¨ì¤„ ë•Œ HTTP í—¤ë” ë°©ì‹ì„ ì‚¬ìš©í•˜ë ¤ê³  í•˜ë©´ 302 ìƒíƒœ ì½”ë“œ ë•Œë¬¸ì— í”„ë¡ íŠ¸ì—”ë“œì—ì„œ "Location" ì™¸ì˜ HTTP í—¤ë”ë¥¼ ì½ì§€ ëª»í•˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•¨
- ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‘ë‹µì—ì„œë„ ì¿ í‚¤ ì„¤ì •ì€ ì •ìƒì ìœ¼ë¡œ ë™ì‘
    - ë°±ì—”ë“œê°€ ë¦¬ë‹¤ì´ë ‰íŠ¸(ì˜ˆ, 302 ì‘ë‹µ)ë¥¼ ë³´ë‚¼ ë•Œ ì‘ë‹µ í—¤ë”ì— "Set-Cookie"ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´, ë¸Œë¼ìš°ì €ëŠ” ìë™ìœ¼ë¡œ í•´ë‹¹ ì¿ í‚¤ë¥¼ ì¿ í‚¤ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•œ í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²˜ë¦¬ë¥¼ ì§„í–‰

## ë¬¸ì œ í•´ê²° ë°©ë²•

- refresh tokenë§Œ ë¨¼ì € ë°œê¸‰
    
    1. SuccessHandlerì—ì„œ refresh tokenë§Œ ì¿ í‚¤ ë°©ì‹ìœ¼ë¡œ ë°œê¸‰
    2. sendRedirectUrl ì„¤ì •ìœ¼ë¡œ í”„ë¡ íŠ¸ì—”ë“œì˜ íŠ¹ì •í•œ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜
    3. í”„ë¡ íŠ¸ì—”ë“œì˜ íŠ¹ì •í•œ í˜ì´ì§€ëŠ” ìš”ì²­ì´ ì˜¨ë‹¤ë©´ ë¬´ì¡°ê±´ useEffectì™€ ê°™ì€ í•¨ìˆ˜ë¡œ ë°±ì—”ë“œì˜ íŠ¹ì • ê²½ë¡œë¡œ axiosë‚˜ fetchë¡œ ìš”ì²­. ì´ ë•Œ ì¿ í‚¤ì— ë‹´ê²¨ ìˆëŠ” refresh tokenë„ ìë™ìœ¼ë¡œ ë”°ë¼ê°ˆ ìˆ˜ ìˆë„ë¡ credentials ê°’ì€ trueë¡œ ì„¤ì •
    4. ë°±ì—”ë“œëŠ” ìš”ì²­ì— ëŒ€í•´ refresh tokenì„ ê²€ì¦í•˜ê³  access, refresh token ì¬ë°œê¸‰
    
    - access token, refresh token ì „ë‹¬ ë° ì €ì¥ ë°©ì‹
        - accessëŠ” HTTP í—¤ë”ë¥¼ í†µí•´ ì „ë‹¬, refreshëŠ” ì¿ í‚¤ë¡œ ì „ë‹¬ (ê¶Œì¥)
        - access, refresh ëª¨ë‘ HTTP í—¤ë”ë¥¼ í†µí•´ ì „ë‹¬
        - access, refresh ëª¨ë‘ ì¿ í‚¤ë¡œ ì „ë‹¬

### **ATK(AccessToken), RTK(RefreshToken)ì— ê´€í•œ ê³ ì°°**

## ê¸°ë³¸ì ì¸ í”„ë¡œì„¸ìŠ¤

- ë§Œë£Œëœ ATKì™€ í•¨ê»˜ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìš”ì²­ì„ ë³´ëƒ„
- ì„œë²„ì—ì„œ RTKë¥¼ ìš”ì²­í•˜ëŠ” ì‘ë‹µì„ ë³´ëƒ„
- í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë§Œë£Œëœ ATKì™€ RTKë¥¼ í•¨ê»˜ ë³´ëƒ„
- ì„œë²„ì—ì„œ ATKê°€ ë§Œë£Œëœ ê²ƒê³¼ RTKê°€ ìœ íš¨í•œ ê²ƒì„ í™•ì¸ í›„ ATKë¥¼ ìƒˆë¡œ ë°œê¸‰í•´ì¤Œ
- ì´ ë•Œ, RTK ë˜í•œ ìƒˆë¡œ ë°œê¸‰í•´ì£¼ëŠ” ê²ƒì´ RTR(Refresh Token Rotation)ì„

## ë§Œì•½ ATKê°€ íƒˆì·¨ ë‹¹í–ˆë‹¤ë©´

- ATKê°€ ë§Œë£Œë˜ê¸° ì „ê¹Œì§€ëŠ” ë¬´ë°©ë¹„ ìƒíƒœì„

## ë§Œì•½ RTKì´ íƒˆì·¨ ë‹¹í–ˆë‹¤ë©´

- RTKë¥¼ í†µí•´ ATKë¥¼ ìƒˆë¡œ ë°œê¸‰ ë°›ì„ ê°€ëŠ¥ì„±ì´ ìˆìŒ
- RTKë¥¼ í†µí•´ ATKë¥¼ ìƒˆë¡œ ë°œê¸‰ ë°›ê¸° ìœ„í•´ì„œëŠ” ë¬´ì¡°ê±´ ë§Œë£Œëœ ATKì™€ RTKë¥¼ í•¨ê»˜ ì„œë²„ì— ë³´ë‚´ë„ë¡ í•¨
- ì¶”ê°€ì ìœ¼ë¡œ ë§Œë£Œë˜ì§€ ì•Šì€ ATKì™€ RTKë¥¼ í•¨ê»˜ ì„œë²„ì— ë³´ëƒˆì„ ë•Œ ATKì™€ RTKë¥¼ ëª¨ë‘ ë¬´íš¨í™”í•¨
- RTKì€ ì„œë²„ì—ì„œ ì§€ìš°ê³ , ATKì€ ë§Œë£Œ ì‹œê°„ì„ 0ìœ¼ë¡œ ì„¤ì •

## ë§Œì•½ ATK, RTKë¥¼ í•¨ê»˜ íƒˆì·¨ ë‹¹í–ˆë‹¤ë©´

- ATKê°€ ë§Œë£Œë˜ê³  ì•„ì´ë”” ì£¼ì¸ì´ RTKë¥¼ í†µí•´ ATK, RTKë¥¼ ìƒˆë¡œ ë°œê¸‰ ë°›ê¸° ì „ê¹Œì§€ ë¬´ë°©ë¹„ ìƒíƒœì„
- ATKê°€ ë§Œë£Œë˜ê³  íƒˆì·¨í•œ ìê°€ RTKë¥¼ í†µí•´ ATK, RTKë¥¼ ìƒˆë¡œ ë°œê¸‰ ë°›ì•˜ë‹¤ë©´, ì•„ì´ë”” ì£¼ì¸ì´ RTKë¥¼ í†µí•´ ATK, RTKë¥¼ ìš”ì²­í–ˆì„ ë•Œ ì•„ì´ë”” ì£¼ì¸ì´ ê°€ì§„ RTKê°€ ìœ íš¨í•˜ì§€ ì•Šì€ ê²ƒì´ í™•ì¸ë¨
- RTKì´ ìœ íš¨í•˜ì§€ ì•Šì€ ê²ƒì´ í™•ì¸ë˜ë©´ ì„œë²„ê°€ ë³´ê´€í•˜ê³  ìˆëŠ” RTKë„ ì§€ì›Œì„œ ëª¨ë“  RTKë¥¼ ë¬´íš¨í™”í•˜ê³  ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜í•¨

## ë¹„ìŠ·í•œ ì‹œê°„ì— ì„œë¡œ ë‹¤ë¥¸ ì¥ì†Œì—ì„œ ë¡œê·¸ì¸ì„ í–ˆì„ ë•Œ

- ë¨¼ì € ë¡œê·¸ì¸í•œ ê³³ì—ì„œ ë°œê¸‰ ë°›ì€ RTKì´ ì„œë²„ì— ì €ì¥ë˜ì–´ ìˆëŠ” ìƒíƒœì—ì„œ ë‚˜ì¤‘ì— ë¡œê·¸ì¸í•œ ê³³ì—ì„œ RTKë¥¼ ë°œê¸‰ ì‹œë„í•¨
- ì„œë²„ì— ì €ì¥ëœ RTKì´ ë‚˜ì¤‘ì— ë¡œê·¸ì¸í•œ ê³³ì˜ RTKìœ¼ë¡œ ëŒ€ì²´ë¨
- ë¨¼ì € ë¡œê·¸ì¸í•œ ê³³ì—ì„œëŠ” ATKê°€ ë§Œë£Œë˜ì—ˆì„ ë•Œ RTKì´ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì¬ ë¡œê·¸ì¸í•´ì•¼ í•¨

## ê²°ë¡ 

- RTKë§Œ íƒˆì·¨ ë‹¹í•œ ê²½ìš°, RTKë§Œìœ¼ë¡œ í•  ìˆ˜ ìˆëŠ” ê²ƒì€ ì—†ìœ¼ë¯€ë¡œ ê´œì°®ìŒ
- ATKë¥¼ íƒˆì·¨ ë‹¹í•œ ê²½ìš°, ATKê°€ ë§Œë£Œë˜ê¸° ì „ê¹Œì§€ëŠ” ë¬´ë°©ë¹„ ìƒíƒœì„
- ATKì™€ RTKë¥¼ ëª¨ë‘ íƒˆì·¨ ë‹¹í•œ ê²½ìš°, ATKê°€ ë§Œë£Œëœ í›„ ì•„ì´ë”” ì£¼ì¸ì´ RTKë¥¼ í†µí•´ ATK, RTKë¥¼ ìš”ì²­í•˜ê¸° ì „ê¹Œì§€ ë¬´ë°©ë¹„ ìƒíƒœì„ -> ë¸Œë¼ìš°ì €ì˜ ì¿ í‚¤ì— ì €ì¥ëœ ATK, RTKì€ íƒˆì·¨í•˜ê¸° ì‰¬ìš´ ê±° ì•„ë‹Œê°€??????

---

## ìš”ì²­ìœ¼ë¡œ ì˜¬ ìˆ˜ ìˆëŠ” í† í° ì¡°í•©

- ë§Œë£Œë˜ì§€ ì•Šì€ ATK -> ë¬´ë°©ë¹„
- ë§Œë£Œëœ ATK -> RTK ìš”ì²­
- ë§Œë£Œëœ ATK + ìœ íš¨í•œ RTK -> ATK, RTK ëª¨ë‘ ìƒˆë¡œ ë°œê¸‰
- ë§Œë£Œëœ ATK + ìœ íš¨í•˜ì§€ ì•Šì€ RTK -> RTK ì‚­ì œ ë° 401 ë°˜í™˜
- ë§Œë£Œë˜ì§€ ì•Šì€ ATK + ìœ íš¨í•œ RTK -> RTK ì‚­ì œ ë° 401 ë°˜í™˜
- ë§Œë£Œë˜ì§€ ì•Šì€ ATK + ìœ íš¨í•˜ì§€ ì•Šì€ RTK -> RTK ì‚­ì œ ë° 401 ë°˜í™˜
- ìœ íš¨í•œ RTK -> RTK ì‚­ì œ ë° 401 ë°˜í™˜
- ìœ íš¨í•˜ì§€ ì•Šì€ RTK -> RTK ì‚­ì œ ë° 401 ë°˜í™˜

---

## ìµœì¢… ê°œë°œ ê³ ë ¤ ì‚¬í•­

- ATKë§Œ ì™”ì„ ë•Œ -> ë§Œë£Œ ìœ ë¬´ í™•ì¸ í›„ ì•Œë§ì€ ì½”ë“œ ìˆ˜í–‰
- ATK, RTK ê°™ì´ ì™”ì„ ë•Œ
    - ATK ë§Œë£Œë¨ -> RTK ìœ íš¨í•œì§€ í™•ì¸ í›„ ì•Œë§ì€ ì½”ë“œ ìˆ˜í–‰
    - ATK ë§Œë£Œë˜ì§€ ì•ŠìŒ -> RTK ì‚­ì œ ë° 401 ë°˜í™˜
- RTKë§Œ ì™”ì„ ë•Œ -> RTK ì‚­ì œ ë° 401 ë°˜í™˜

---

## 1. ì¼ë°˜ API ìš”ì²­

### 1-1. Access tokenë§Œ ì „ë‹¬ëœ ê²½ìš°

- **ìœ íš¨í•œ ê²½ìš°:**
    - **ì²˜ë¦¬:** ìš”ì²­ì„ ì •ìƒ ì²˜ë¦¬
    - **ì‘ë‹µ ì½”ë“œ:** 200 OK
- **ë§Œë£Œë˜ì—ˆê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš°:**
    - **ì²˜ë¦¬:** access token ê²€ì¦ ì‹¤íŒ¨
    - **ì‘ë‹µ ì½”ë“œ:** 401 Unauthorized
    - **ì—ëŸ¬ ë©”ì‹œì§€:**
        - `"ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œëœ access tokenì…ë‹ˆë‹¤. í† í°ì„ ê°±ì‹ í•´ì£¼ì„¸ìš”."`

### 1-2. Access tokenê³¼ í•¨ê»˜ Refresh tokenì´ í•¨ê»˜ ì „ë‹¬ëœ ê²½ìš°

- **ì˜µì…˜ A (refresh token ë¬´ì‹œ, ë¡œê¹… í¬í•¨):**
    - **access tokenì´ ìœ íš¨í•œ ê²½ìš°:**
        - **ì²˜ë¦¬:** access tokenë§Œ ê²€ì¦í•˜ê³  refresh tokenì€ ë¬´ì‹œ (ë‹¨, ë‚´ë¶€ ë¡œê¹…)
        - **ì‘ë‹µ ì½”ë“œ:** 200 OK
    - **access tokenì´ ë§Œë£Œë˜ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš°:**
        - **ì²˜ë¦¬:** access token ê²€ì¦ ì‹¤íŒ¨
        - **ì‘ë‹µ ì½”ë“œ:** 401 Unauthorized
        - **ì—ëŸ¬ ë©”ì‹œì§€:**
            - `"ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œëœ access tokenì…ë‹ˆë‹¤. í† í°ì„ ê°±ì‹ í•´ì£¼ì„¸ìš”."`
- **ì˜µì…˜ B (ë³´ì•ˆ ìœ„í˜‘ìœ¼ë¡œ íŒë‹¨í•˜ì—¬ ë‘ í† í° ëª¨ë‘ ë¬´íš¨í™”):**
    - **ì–´ë– í•œ ê²½ìš°ì—ë„:**
        - **ì²˜ë¦¬:** refresh tokenì´ ì¼ë°˜ API ìš”ì²­ì— í¬í•¨ëœ ê²ƒì„ ë³´ì•ˆ ì´ìƒìœ¼ë¡œ ê°„ì£¼
        - **ì‘ë‹µ ì½”ë“œ:** 401 Unauthorized
        - **ì—ëŸ¬ ë©”ì‹œì§€:**
            - `"ë¶€ì ì ˆí•œ í† í° ì¡°í•©ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì¬ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."`

### 1-3. **Refresh tokenë§Œ ì „ë‹¬ëœ ê²½ìš° (ì¼ë°˜ API ìš”ì²­)**

- **ì²˜ë¦¬:**
    - ì¼ë°˜ API ìš”ì²­ì—ì„œëŠ” access tokenì´ ë°˜ë“œì‹œ ìˆì–´ì•¼ í•˜ë¯€ë¡œ, refresh tokenë§Œ ìˆëŠ” ê²½ìš°ëŠ” ì˜ëª»ëœ ìš”ì²­ìœ¼ë¡œ íŒë‹¨í•©ë‹ˆë‹¤.
- **ì‘ë‹µ ì½”ë“œ:** 401 Unauthorized
- **ì—ëŸ¬ ë©”ì‹œì§€:**
    - `"ì¸ì¦ì— í•„ìš”í•œ access tokenì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜¬ë°”ë¥¸ ì¸ì¦ ì •ë³´ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”."`

---

## 2. í† í° ê°±ì‹  ìš”ì²­ (ì˜ˆ: `/auth/refresh` ì—”ë“œí¬ì¸íŠ¸)

í† í° ê°±ì‹  ìš”ì²­ì—ì„œëŠ” ì£¼ë¡œ HttpOnly ì¿ í‚¤ë¡œ ì „ë‹¬ë˜ëŠ” refresh tokenì„ ê¸°ë°˜ìœ¼ë¡œ ìƒˆë¡œìš´ í† í°ì„ ë°œê¸‰í•©ë‹ˆë‹¤. ì•„ë˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤ë³„ ì²˜ë¦¬ ë°©ì‹ì…ë‹ˆë‹¤.

### 2-1. Refresh tokenë§Œ ì „ë‹¬ëœ ê²½ìš°

- **ìœ íš¨í•œ ê²½ìš°:**
    - **ì²˜ë¦¬:** refresh token ê²€ì¦ í›„ ìƒˆë¡œìš´ access token(ë° í•„ìš” ì‹œ refresh token) ë°œê¸‰
    - **ì‘ë‹µ ì½”ë“œ:** 200 OK
- **ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš°:**
    - **ì²˜ë¦¬:** refresh token ê²€ì¦ ì‹¤íŒ¨
    - **ì‘ë‹µ ì½”ë“œ:** 401 Unauthorized (ë˜ëŠ” ë³´ì•ˆ ì •ì±…ì— ë”°ë¼ 403 Forbiddenë„ ê³ ë ¤ ê°€ëŠ¥)
    - **ì—ëŸ¬ ë©”ì‹œì§€:**
        - `"ìœ íš¨í•˜ì§€ ì•Šì€ refresh tokenì…ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”."`

### 2-2. ë§Œë£Œëœ access tokenê³¼ í•¨ê»˜ refresh tokenì´ ì „ë‹¬ëœ ê²½ìš°

- **access tokenì´ ë§Œë£Œë˜ì—ˆê³  refresh tokenì´ ìœ íš¨í•œ ê²½ìš°:**
    - **ì²˜ë¦¬:** refresh tokenì„ í†µí•´ ìƒˆë¡œìš´ í† í° ë°œê¸‰
    - **ì‘ë‹µ ì½”ë“œ:** 200 OK
- **access tokenì´ ì•„ì§ ìœ íš¨í•œ ê²½ìš° (ì˜ˆìƒì¹˜ ëª»í•œ ìƒí™©):**
    - **ì²˜ë¦¬:** ë³´ì•ˆìƒì˜ ë¬¸ì œë¡œ ê°„ì£¼
        - ë‘ í† í° ëª¨ë‘ë¥¼ ë¬´íš¨í™”í•˜ê³  ê°•ì œ ì¬ë¡œê·¸ì¸ì„ ìœ ë„
    - **ì‘ë‹µ ì½”ë“œ:** 401 Unauthorized
    - **ì—ëŸ¬ ë©”ì‹œì§€:**
        - `"ìœ íš¨í•œ access tokenê³¼ í•¨ê»˜ refresh tokenì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤. ë³´ì•ˆìƒì˜ ì´ìœ ë¡œ ì¬ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤."`

### 2-3. Access tokenë§Œ ì „ë‹¬ëœ ê²½ìš°

- **ì²˜ë¦¬:**
    - í† í° ê°±ì‹  ìš”ì²­ì—ëŠ” ë°˜ë“œì‹œ refresh tokenì´ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
- **ì‘ë‹µ ì½”ë“œ:** 401 Unauthorized
- **ì—ëŸ¬ ë©”ì‹œì§€:**
    - `"í† í° ê°±ì‹  ìš”ì²­ì— refresh tokenì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤."`

### 2-4. ë‘ í† í° ëª¨ë‘ ì „ë‹¬ë˜ì§€ ì•Šì€ ê²½ìš°

- **ì²˜ë¦¬:**
    - ì¸ì¦ ì •ë³´ê°€ ì „í˜€ ì—†ìœ¼ë¯€ë¡œ ìš”ì²­ ê±°ë¶€
- **ì‘ë‹µ ì½”ë“œ:** 401 Unauthorized
- **ì—ëŸ¬ ë©”ì‹œì§€:**
    - `"ì¸ì¦ ì •ë³´ê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."`

### **OAuth2 í´ë¼ì´ì–¸íŠ¸ JWT ë¡œê·¸ì¸ êµ¬í˜„ ë¡œì§**

## í”„ë¡ íŠ¸ì—”ë“œì™€ ë°±ì—”ë“œ ê°„ ìƒí˜¸ì‘ìš© ë° ë¡œê·¸ì¸ ë¡œì§ êµ¬í˜„ ê³¼ì •

1. **ë¡œê·¸ì¸ ìš”ì²­ ì‹œì‘**
    - ì‚¬ìš©ìê°€ "ë¡œê·¸ì¸" ë²„íŠ¼(ë˜ëŠ” í•˜ì´í¼ë§í¬)ì„ í´ë¦­
    - í”„ë¡ íŠ¸ì—”ë“œëŠ” `location.href`ë¥¼ ì‚¬ìš©í•´ OAuth2 ì¸ì¦ ì„œë²„ì˜ ì¸ê°€(authorization) ì—”ë“œí¬ì¸íŠ¸ë¡œ ë¸Œë¼ìš°ì €ë¥¼ ë¦¬ë‹¤ì´ë ‰íŠ¸
    - ì´ë•Œ URLì—ëŠ” `client_id`, `redirect_uri`, `response_type`, `scope` ë“± í•„ìš”í•œ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ê°€ í¬í•¨ë¨
2. **ì™¸ë¶€ ì¸ì¦ ì²˜ë¦¬**
    - ì‚¬ìš©ìëŠ” ì™¸ë¶€ ì¸ì¦ ì œê³µìì˜ ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ìì‹ ì˜ ìê²© ì¦ëª…ì„ ì…ë ¥í•˜ê³ , ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í• ì§€ ì—¬ë¶€ë¥¼ ê²°ì •
    - ì¸ì¦ ì œê³µìëŠ” ì‚¬ìš©ì ì¸ì¦ì´ ì™„ë£Œë˜ë©´, ì‚¬ì „ì— ë“±ë¡ëœ `redirect_uri`(ë³´í†µ ë°±ì—”ë“œë¡œì˜ uri)ë¡œ ë¸Œë¼ìš°ì €ë¥¼ ë¦¬ë‹¤ì´ë ‰íŠ¸í•¨. ì´ë•Œ ì¸ê°€ ì½”ë“œ(authorization code)ê°€ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì— í¬í•¨ë˜ì–´ ì „ë‹¬ë¨
3. **ì¸ê°€ ì½”ë“œ ìˆ˜ì‹  ë° í† í° êµí™˜**
    - ë°±ì—”ë“œëŠ” í•´ë‹¹ ì¸ê°€ ì½”ë“œë¥¼ ë°›ì•„ OAuth2 ì œê³µìì˜ í† í° ì—”ë“œí¬ì¸íŠ¸ë¡œ ìš”ì²­ì„ ë³´ë‚´ê³ , ì´ë¥¼ í†µí•´ ì•¡ì„¸ìŠ¤ í† í°ì„ ë°œê¸‰ë°›ìŒ
4. **ì„¸ì…˜ ìƒì„± ë° ì‚¬ìš©ì ì •ë³´ ì²˜ë¦¬**
    - ë°œê¸‰ë°›ì€ ì•¡ì„¸ìŠ¤ í† í°ì„ ì‚¬ìš©í•´ ë°±ì—”ë“œëŠ” ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒí•˜ê±°ë‚˜, í•„ìš”í•œ ì¸ì¦ ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•œ í›„ ì‚¬ìš©ì ì„¸ì…˜ì„ ìƒì„±
    - ì´í›„ ë°±ì—”ë“œëŠ” í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŒì„ ì•Œë ¤ì£¼ê³ , í”„ë¡ íŠ¸ì—”ë“œëŠ” ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ ë¡œê·¸ì¸ ìƒíƒœë¥¼ ë°˜ì˜

---

## ë°±ì—”ë“œ ì•ˆì—ì„œì˜ ë¡œì§

- ìš°ë¦¬ê°€ ê°œë°œí•˜ëŠ” ì„œë²„: í´ë¼ì´ì–¸íŠ¸ ì„œë²„ (Java Spring, Spring Security ì‚¬ìš©)
- OAuth2 ë¡œê·¸ì¸ì„ ìœ„í•œ ì„œë²„ (Google, Naver ë“±): ì¸ì¦ ì„œë²„ ë° ë¦¬ì†ŒìŠ¤ ì„œë²„

### OAuth2AutorizationRequestRedirectFilter

- 'org.springframework.boot:spring-boot-starter-oauth2-client' ì˜ì¡´ì„±ì— ì˜í•´ Spring Security FilterChainì— ìë™ìœ¼ë¡œ ì¶”ê°€ë¨
- OAuth2 ë¡œê·¸ì¸ ê³¼ì •ì—ì„œ ìë™ìœ¼ë¡œ ê±°ì¹˜ëŠ” í•„í„°ì´ë©° ë”°ë¡œ ì»¤ìŠ¤í…€í•  í•„ìš” ì—†ìŒ
- ì†Œì…œ ë¡œê·¸ì¸ ì‹œë„ ì‹œì— í•´ë‹¹ í•„í„°ì— ì˜í•´ ì¸ì¦ ì„œë²„ì˜ ì†Œì…œ ë¡œê·¸ì¸ í˜ì´ì§€ ì£¼ì†Œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë¨
    - Spring Securityê°€ Google OAuth2 ë¡œê·¸ì¸ì„ ìœ„í•´ ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µí•˜ëŠ” ì—”ë“œí¬ì¸íŠ¸: `/oauth2/authorization/google`
- ì¸ì¦ ì„œë²„ì—ì„œ í•´ë‹¹ ì„œë¹„ìŠ¤ì˜ ë¡œê·¸ì¸ í˜ì´ì§€ë¥¼ ì‚¬ìš©ì í™”ë©´ì— ë„ì›€
- ë¡œê·¸ì¸ì„ ì„±ê³µí•˜ë©´ ì¸ì¦ ì„œë²„ì— ë“±ë¡í•´ë‘” í´ë¼ì´ì–¸íŠ¸ ì„œë²„ì˜ ì£¼ì†Œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë˜ë©° Authorization Codeë¥¼ ë°œê¸‰í•˜ì—¬ ì¤Œ
- ì¸ì¦ ì„œë²„ì— ë“±ë¡í•´ë‘ëŠ” ì£¼ì†ŒëŠ” ë³´í†µ "/login/oauth2/code/ì„œë¹„ìŠ¤ëª…"

### â†“

### OAuth2LoginAuthenticationFilter

- 'org.springframework.boot:spring-boot-starter-oauth2-client' ì˜ì¡´ì„±ì— ì˜í•´ Spring Security FilterChainì— ìë™ìœ¼ë¡œ ì¶”ê°€ë¨
- OAuth2 ë¡œê·¸ì¸ ê³¼ì •ì—ì„œ ìë™ìœ¼ë¡œ ê±°ì¹˜ëŠ” í•„í„°ì´ë©° ë”°ë¡œ ì»¤ìŠ¤í…€í•  í•„ìš” ì—†ìŒ
- ì¸ì¦ ì„œë²„ì—ì„œ ë¡œê·¸ì¸ ì„±ê³µì„ í•˜ë©´ í´ë¼ì´ì–¸íŠ¸ ì„œë²„ì˜ ì„¤ì • íŒŒì¼ì— ë“±ë¡í•´ë‘” ì£¼ì†Œì— ë”°ë¼ ìš°ë¦¬ ì„œë²„ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë¨
- í´ë¼ì´ì–¸íŠ¸ ì„œë²„ì˜ ì„¤ì • íŒŒì¼ì— ë“±ë¡í•´ë‘” ì£¼ì†ŒëŠ” ì¸ì¦ ì„œë²„ì— ë“±ë¡í•´ë‘ëŠ” ì£¼ì†Œì™€ ë™ì¼í•¨
- ì¸ì¦ ì„œë²„ì—ì„œ ë°œê¸‰ ë°›ì€ Authorization Codeë¥¼ ë‹¤ì‹œ ì¸ì¦ ì„œë²„ì— ë³´ë‚´ Access Tokenì„ ë°œê¸‰ ë°›ìŒ

### â†“

### OAuth2LoginAuthenticationProvider

- 'org.springframework.boot:spring-boot-starter-oauth2-client' ì˜ì¡´ì„±ì— ì˜í•´ Spring Security FilterChainì— ìë™ìœ¼ë¡œ ì¶”ê°€ë¨
- OAuth2 ë¡œê·¸ì¸ ê³¼ì •ì—ì„œ ìë™ìœ¼ë¡œ ê±°ì¹˜ëŠ” Providerì´ë©° ë”°ë¡œ ì»¤ìŠ¤í…€í•  í•„ìš” ì—†ìŒ
- ì¸ì¦ ì„œë²„ì—ì„œ ë°œê¸‰ ë°›ì€ Access Tokenì„ ë¦¬ì†ŒìŠ¤ ì„œë²„ë¡œ ë³´ë‚´ ì‚¬ìš©ì ì •ë³´ë¥¼ íšë“í•¨

### â†“

### JwtAuthenticationFilter

- ì–´ë–¤ ìš”ì²­ì´ë“  ê±°ì³ê°€ëŠ” í•„í„°
- OncePerRequestFilterë¥¼ ìƒì† ë°›ìŒ
- ì¿ í‚¤ì—ì„œ Access Tokenì„ ì°¾ìŒ
- Access Token ìœ ë¬´, í† í° ë§Œë£Œ ì—¬ë¶€ í™•ì¸
- Access Token ê¸°ë°˜ìœ¼ë¡œ OAuth2User ìƒì„±
- customOAuth2Userë¥¼ ê°€ì§€ê³  ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì¸ì¦ í† í° ìƒì„±
- SecurityContextHolderì— Authenticationì„ í•´ë‹¹ í† í°ìœ¼ë¡œ ì„¤ì •
    - SecurityFilterChain ì„¤ì • ê³¼ì •ì—ì„œ ì¸ì¦ ë° ê¶Œí•œì´ í•„ìš”í•˜ë‹¤ê³  ì„¤ì •í•œ ìš”ì²­ì— ëŒ€í•´ì„œëŠ” ì´ Authentication ê°ì²´ë¥¼ í†µí•´ ì‚¬ìš©ì ì¸ì¦ ì—¬ë¶€ ë° ê¶Œí•œì„ í™•ì¸í•¨
- í•´ë‹¹ ìš”ì²­ ë‚´ì—ì„œ @AuthenticationPrincipalì„ í†µí•´ customOAuth2User ì‚¬ìš© ê°€ëŠ¥

### â†“

### CustomOAuth2UserService

- OAuth2 ë¡œê·¸ì¸ ê³¼ì •ì—ì„œ ê±°ì¹˜ëŠ” ì„œë¹„ìŠ¤
- ìŠ¤í”„ë§ ì‹œíë¦¬í‹° í•„í„° ì²´ì¸ê³¼ ì¸ì¦ ì„œë²„, ë¦¬ì†ŒìŠ¤ ì„œë²„ë¥¼ ëª¨ë‘ ê±°ì¹œ í›„ì— ë°›ì•„ì˜¨ ì‚¬ìš©ì ì •ë³´ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì„œë¹„ìŠ¤
- OAuth2UserServiceë¥¼ êµ¬í˜„í•œ DefaultOAuth2UserServiceë¥¼ ìƒì† ë°›ìŒ
- loadUser() ë©”ì†Œë“œë¥¼ overrideí•˜ì—¬ êµ¬í˜„í•¨
- loadUser() ë©”ì†Œë“œì˜ ì¸ì ê°’ì¸ OAuth2UserRequestì˜ OAuth2Userì— ì‚¬ìš©ì ì •ë³´ê°€ ë‹´ê²¨ ìˆìŒ
- OAuth2Userë¥¼ í•„ìš”ì— ë§ê²Œ êµ¬í˜„ ë° ìƒì†í•˜ê³  ê°ì²´ë¥¼ ìƒì„±í•˜ì—¬ ë¦¬í„´í•¨
- ë¦¬í„´ëœ ê°ì²´ëŠ” Authenticatoin ê°ì²´ì— ì €ì¥ë¨

### â†“

### SuccessHandler

- OAuth2 ë¡œê·¸ì¸ ê³¼ì •ì—ì„œ ê±°ì¹˜ëŠ” í•¸ë“¤ëŸ¬
- ì¸ì¦ ì„œë²„ì—ì„œ ë¡œê·¸ì¸ì— ì„±ê³µí•˜ê³  ë¦¬ì†ŒìŠ¤ ì„œë²„ì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°›ì•„ì˜¨ í›„ OAuth2UserServiceë¥¼ ê±°ì³ì„œ ë¡œê·¸ì¸ì— ì„±ê³µí•œ í›„ ì‹¤í–‰ë˜ëŠ” í•¸ë“¤ëŸ¬
- AuthenticationSuccessHandlerë¥¼ êµ¬í˜„í•œ SimpleUrlAuthenticationSuccessHandlerë¥¼ ìƒì† ë°›ìŒ
- onAuthenticationSuccess() ë©”ì†Œë“œë¥¼ overrideí•˜ì—¬ êµ¬í˜„í•¨
- Access Token ë°œê¸‰ (ì¸ì¦ ì„œë²„ì—ì„œ ë°›ëŠ” Access Tokenê³¼ ë‹¤ë¦„)
    - onAuthenticationSuccess() ë©”ì†Œë“œì˜ ì¸ì ì¤‘ Authenticatoin ê°ì²´ì— ì €ì¥ëœ OAuth2Userë¥¼ ê¸°ë°˜ìœ¼ë¡œ AccessTokenì„ ë°œê¸‰í•¨
    - ë¡œê·¸ì¸ ì„±ê³µ ì´í›„ ì´ì–´ì§€ëŠ” ìš”ì²­ì— ëŒ€í•´ Access Tokenì˜ ìœ íš¨ì„±ì„ ê²€ì¦í•˜ê³  JwtAuthenticationFilterì—ì„œ OAuth2Userë¥¼ ìƒì„±í•˜ëŠ” ë° ì‚¬ìš©
- Refresh Token ë°œê¸‰
- Access Token, Refresh Token ì¿ í‚¤ì— ì €ì¥
- Refresh Token DBì— ì €ì¥
- ì‚¬ìš©ì ì •ë³´ê°€ DBì— ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
- ì‹ ê·œ íšŒì› ì—¬ë¶€ì— ë”°ë¼ ë‹¤ë¥¸ urlë¡œ ë¦¬ë””ë ‰ì…˜

### í•µì‹¬ ë¡œì§

- JwtAuthenticationFilter, CustomOAuth2UserService, AuthenticationSuccessHandlerë¥¼ êµ¬í˜„í•¨
    - AuthenticationSuccessHandlerëŠ” í¼ ë¡œê·¸ì¸ ë°©ì‹ì—ì„œ UsernamePasswordAuthenticationFilterì™€ ë¹„ìŠ·í•œ ì—­í• 
- CustomOAuth2UserServiceì—ì„œ ë°›ì•„ì˜¨ ì‚¬ìš©ì ì •ë³´ë¥¼ í•„ìš”ì— ë§ê²Œ OAuth2User êµ¬í˜„ ê°ì²´ì— ë‹´ìŒ
- AuthenticationSuccessHandlerì—ì„œ OAuth2Userë¥¼ ë°”íƒ•ìœ¼ë¡œ Access Tokenì„ JWT í˜•ì‹ìœ¼ë¡œ ë°œê¸‰í•˜ê³  ì¿ í‚¤ì— ë‹´ì•„ ì‚¬ìš©ìì—ê²Œ ë³´ëƒ„
- ë¡œê·¸ì¸ ì´í›„ ìš”ì²­ì— ëŒ€í•´ JwtAuthenticationFilterê°€ ìš”ì²­ì— í¬í•¨ëœ Access Tokenì˜ ìœ íš¨ì„±ì„ í™•ì¸í•˜ê³  Access Tokenì„ ë°”íƒ•ìœ¼ë¡œ OAuth2Userë¥¼ ìƒì„±í•˜ì—¬ ì„œë²„ ì„¸ì…˜ì— í¬í•¨í•¨
- ìš”ì²­ì„ ì²˜ë¦¬í•  ë•Œ ì„œë²„ ì„¸ì…˜ì— ìˆëŠ” OAuth2Userë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ ì‹ ì›ì„ íŒŒì•…í•¨
- JWT ë°©ì‹ì˜ ë¡œê·¸ì¸ ì„œë¹„ìŠ¤ë¥¼ êµ¬í˜„í•˜ë¯€ë¡œ ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì„¤ì •ì—ì„œ Session ì •ì±…ì„ Statelessë¡œ ì„¤ì •í•¨
- ì„œë²„ ì„¸ì…˜ì— í¬í•¨ëœ OAuth2UserëŠ” ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì˜ Session Stateless ì„¤ì •ì— ì˜í•´ í•´ë‹¹ ìš”ì²­ì´ ëë‚˜ë©´ ì‚¬ë¼ì§
- ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì„¤ì •, JWT ê²€ì¦ ë° ë°œê¸‰ì— ëŒ€í•œ ì½”ë“œëŠ” ë”°ë¡œ êµ¬í˜„í•¨

## ì¶”ê°€ êµ¬í˜„ ì‚¬í•­

### ë¡œê·¸ì¸ ì¸ì¦ ì‹¤íŒ¨ ì‹œ

- ê¸°ë³¸ì ìœ¼ë¡œ Spring Securityì—ì„œëŠ” ë³´í˜¸ëœ URIì— ëŒ€í•´ ì¸ì¦ì´ ì—†ëŠ” ìƒíƒœë¡œ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´, ë‚´ë¶€ì ìœ¼ë¡œ AuthenticationEntryPointë¥¼ í˜¸ì¶œ
- AuthenticationEntryPointë¥¼ í†µí•´ 401 ëŒ€ì‹  302 ë¦¬ë‹¤ì´ë ‰ì…˜ ì‘ë‹µ
- ì´ ë•Œ OAuth2AuthorizationRequestRedirectFilterê°€ í•´ë‹¹ ìš”ì²­ì„ ë°›ì•„ ì‹¤ì œ ì†Œì…œ ë¡œê·¸ì¸ í˜ì´ì§€(êµ¬ê¸€ ë¡œê·¸ì¸ í˜ì´ì§€)ë¡œ ì‚¬ìš©ìë¥¼ ì´ë™ì‹œí‚´
- ì¸ì¦ ì‹¤íŒ¨ ì‹œì˜ ë¡œì§ ì»¤ìŠ¤í„°ë§ˆì´ì§• ê°€ëŠ¥
    - SecurityFilterChain ì„¤ì •ì—ì„œ failureUrl() ì„¤ì •
    - failureHandler êµ¬í˜„ í›„ SecurityFilterChain ì„¤ì •ì—ì„œ failureHandler() ì„¤ì •

### **Spring Security**

- ì°¸ê³ : [https://www.devyummi.com/page?id=668bd2d92b88a1ef5f2be2e3](https://www.devyummi.com/page?id=668bd2d92b88a1ef5f2be2e3)

## ê¸°ë³¸ ë°°ê²½ ì§€ì‹

- Servlet Containerì—ëŠ” í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° ì˜¤ëŠ” ìš”ì²­ì´ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ ê°€ê¸° ì „ì— ê±°ì³ì•¼ í•˜ëŠ” í•„í„°ê°€ ì¡´ì¬í•¨
- Spring Securityë¥¼ ì‚¬ìš©í•˜ë©´ Servlet Containerì˜ í•„í„°ì— Spring Securityì˜ í•„í„°ë„ í¬í•¨ë¨
- íŠ¹ì •í•œ ê²½ë¡œì— ìš”ì²­ì´ ì˜¤ë©´ Controller í´ë˜ìŠ¤ì— ë„ë‹¬í•˜ê¸° ì „ í•„í„°ì—ì„œ Spring Securityê°€ ë‹¤ìŒê³¼ ê°™ì´ ê²€ì¦ì„ í•¨
    1. í•´ë‹¹ ê²½ë¡œì˜ ì ‘ê·¼ì€ ëˆ„êµ¬ì—ê²Œ ì—´ë ¤ ìˆëŠ”ê°€
    2. ë¡œê·¸ì¸ì´ ì™„ë£Œëœ ì‚¬ìš©ìì¸ê°€
    3. í•´ë‹¹ë˜ëŠ” roleì„ ê°€ì§€ê³  ìˆëŠ”ê°€

## Spring Security ì¸ê°€ ì‘ì—…

- Security Configuration
    
    - ì¸ê°€ ì„¤ì •ì„ ì§„í–‰í•˜ëŠ” í´ë˜ìŠ¤
    - SecurityFilterChain ì„¤ì •ì„ ì§„í–‰í•¨
- íŠ¹ì • ê²½ë¡œì— ëŒ€í•œ ì¸ê°€ ì„¤ì • ì˜ˆì‹œ ì½”ë“œ
    
    ```java
    package com.example.testsecurity.config;
    
    import org.springframework.context.annotation.Bean;
    import org.springframework.context.annotation.Configuration;
    import org.springframework.security.config.annotation.web.builders.HttpSecurity;
    import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
    import org.springframework.security.web.SecurityFilterChain;
    
    @Configuration
    @EnableWebSecurity
    public class SecurityConfig {
    
        @Bean
        public SecurityFilterChain filterChain(HttpSecurity http) throws Exception{
    
            http
                    .authorizeHttpRequests((auth) -> auth
                            .requestMatchers("/", "/login").permitAll()
                            .requestMatchers("/admin").hasRole("ADMIN")
                            .requestMatchers("/my/**").hasAnyRole("ADMIN", "USER")
                            .anyRequest().authenticated()
                    );
    
            return http.build();
        }
    }
    
    ```
    

## ìŠ¤í”„ë§ ë²„ì „ë³„ êµ¬í˜„ ë°©ì‹ì˜ ë³€í™”

- ìŠ¤í”„ë§ ë¶€íŠ¸ì™€ ìŠ¤í”„ë§ì˜ ë²„ì „ì´ ë°”ë€Œë©´ì„œ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì˜ êµ¬í˜„ ë°©ì‹ë„ ê³„ì† ë°”ë€œ
- GitHubì˜ Spring ë¦¬í¬ì§€í† ë¦¬ì—ì„œ Securityì˜ Release í•­ëª©ì„ í†µí•´ ë³€ê²½ì ì„ í™•ì¸í•  ìˆ˜ ìˆìŒ
    - [https://github.com/spring-projects/spring-security/releases](https://github.com/spring-projects/spring-security/releases)
- ìŠ¤í”„ë§ ë¶€íŠ¸ 3.0.X ë²„ì „ê¹Œì§€ëŠ” HttpSecurity í´ë˜ìŠ¤ì˜ ë©”ì†Œë“œë¥¼ ë‚˜ì—´í•˜ëŠ” í˜•ì‹ì´ì—ˆì§€ë§Œ, ìŠ¤í”„ë§ ë¶€íŠ¸ 3.1.X ë²„ì „ë¶€í„°ëŠ” ìœ„ì˜ Security Config ì¸ê°€ ì„¤ì • ì˜ˆì‹œ ì½”ë“œì™€ ê°™ì´ ëŒë‹¤ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë„ë¡ ë°”ë€œ
- í•­ìƒ ìµœì‹  ë°©ì‹ì´ ë¬´ì—‡ì¸ì§€ í™•ì¸í•´ì•¼ í•¨!

## ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ í˜ì´ì§€ ë¦¬ë””ë ‰ì…˜

- íŠ¹ì • ê²½ë¡œì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì´ ì—†ëŠ” ê²½ìš° ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜ ë˜ë„ë¡ ì„¤ì •í•´ì•¼ í•¨
    
- ì˜ˆì‹œ ì½”ë“œ
    
    ```java
    .
    .
    .
    http
            .formLogin((auth) -> auth
                    .loginPage("/login")
                    .loginProcessingUrl("/loginProc")
                    .permitAll()
            );
    .
    .
    .
    
    ```
    
    - "/login" ê²½ë¡œë¥¼ í†µí•´ ë¡œê·¸ì¸ í˜ì´ì§€ì— ì—°ê²°ë¨
        
    - ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ "/loginProc" ê²½ë¡œë¡œ ì•„ì´ë””ì™€ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì „ì†¡í•¨
        
- ë¡œê·¸ì¸ í˜ì´ì§€ë¥¼ êµ¬í˜„í•œ mustache í…œí”Œë¦¿ íŒŒì¼ ì˜ˆì‹œ ì½”ë“œ
    
    ```html
    <html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
              content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Document</title>
    </head>
    <body>
        login page
        <hr>
        <form action="/loginProc" method="post" name="loginForm">
            <input id="username" type="text" name="username" placeholder="id"/>
            <input id="password" type="password" name="password" placeholder="password"/>
            <input type="submit" value="login"/>
        </form>
    </body>
    </html>
    
    ```
    
    - formLogin ë°©ì‹ì„ ì‚¬ìš©í•˜ë©´ Spring Securityê°€ ìë™ìœ¼ë¡œ UserDetailsì™€ UserDetailsServiceë¥¼ í†µí•´ ê²€ì¦ í›„ SecurityContextì— í•´ë‹¹ ì•„ì´ë””ì— ëŒ€í•œ ì„¸ì…˜ì„ ì €ì¥í•¨ (SecurityContextHolderì˜ Authentication ê°ì²´)

## BCrypt ì•”í˜¸í™” ë©”ì†Œë“œ

- ì‚¬ìš©ì ì¸ì¦(ë¡œê·¸ì¸) ì‹œ ë¹„ë°€ë²ˆí˜¸ì— ëŒ€í•´ ë‹¨ë°©í–¥ í•´ì‹œ ì•”í˜¸í™”ë¥¼ ì§„í–‰í•˜ì—¬ ë¹„ë°€ë²ˆí˜¸ì™€ ëŒ€ì¡°í•¨
    
- ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ëŠ” ì•”í˜¸í™”ë¥¼ ìœ„í•´ BCrypt Password Encoderë¥¼ ì œê³µ ë° ê¶Œì¥í•¨
    
- í•´ë‹¹ ê°ì²´ë¥¼ Beanìœ¼ë¡œ ë“±ë¡í•˜ì—¬ ì‚¬ìš©
    
- Security Configì— ì•”í˜¸í™” Bean ì¶”ê°€ ì˜ˆì‹œ ì½”ë“œ
    
    ```java
    @Bean
    public BCryptPasswordEncoder bCryptPasswordEncoder() {
    
        return new BCryptPasswordEncoder();
    }
    
    ```
    

## DB ì—°ê²°

- application.properties íŒŒì¼ì— db ì—°ê²° ê´€ë ¨ ì½”ë“œ ì‘ì„±
    
- ì˜ˆì‹œ ì½”ë“œ
    
    ```
    spring.application.name=TestSecurity
    
    spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
    spring.datasource.url=jdbc:mysql://127.0.0.1:3306/onrank?useSSL=false&useUnicode=true&serverTimezone=Asia/Seoul&allowPublicKeyRetrieval=true
    spring.datasource.username=onrank
    spring.datasource.password=tocnfqkf@
    
    #Entity ê¸°ë°˜ìœ¼ë¡œ í…Œì´ë¸”ì„ ìë™ ìƒì„± ì—¬ë¶€ ê²°ì •
    spring.jpa.hibernate.ddl-auto=none
    
    #Entityì—ì„œ ì„¤ì •í•œ ë³€ìˆ˜ëª…ì„ MySQL ë””ë¹„ í…Œì´ë¸” ìƒì„±ì‹œ ê·¸ëŒ€ë¡œ ë§¤í•‘
    spring.jpa.hibernate.naming.physical-strategy=org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
    
    ```
    

## íšŒì› ê°€ì… ë¡œì§

- í•„ë“œ ì£¼ì… ë°©ì‹ X -> ìƒì„±ì ì£¼ì… ë°©ì‹ìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•¨
    
- íšŒì›ê°€ì… í˜ì´ì§€ ìƒì„±(mustache)
    
    - ì˜ˆì‹œ ì½”ë“œ
        
        ```xml
        <form action="/joinProc" method="post" name="joinForm">
            <input type="text" name="username" placeholder="Username"/>
            <input type="password" name="password" placeholder="Password"/>
        		<input type="submit" value="Join"/>
        </form>
        
        ```
        
- íšŒì›ê°€ì… ê´€ë ¨ DTO, Controller, Service, Entity, Repository ìƒì„±
    
    - Serviceì˜ íšŒì›ê°€ì… ë©”ì†Œë“œì—ì„œ ìœ ì € ë¹„ë°€ë²ˆí˜¸ë¥¼ ì €ì¥í•  ë•Œ BcryptPasswordEncoder ì‚¬ìš©
        - ì˜ˆì‹œ ì½”ë“œ
            
            ```java
            data.setUsername(joinDTO.getUsername());
            data.setPassword(bCryptPasswordEncoder.encode(joinDTO.getPassword()));
            data.setRole("ROLE_USER");
            
            ```
            
- SecurityConfig ì ‘ê·¼ ê¶Œí•œ ì„¤ì •
    
    - ì˜ˆì‹œ ì½”ë“œ
        
        ```java
        http
                  .authorizeHttpRequests((auth) -> auth
                          .requestMatchers("/", "/login", "/loginProc", "/join", "/joinProc").permitAll()
                          .requestMatchers("/admin").hasRole("ADMIN")
                          .requestMatchers("/my/**").hasAnyRole("ADMIN", "USER")
                          .anyRequest().authenticated()
                  );
        
        ```
        

### **Spring Security JWT**

- SecurityConfig í´ë˜ìŠ¤ì—ì„œ SecurityFilterChain ì„¤ì •ì„ ì§„í–‰í•¨
- SecurityFilterChainì— ì—¬ëŸ¬ í•„í„°ê°€ ë“±ë¡ë˜ì–´ ìˆê³  í•„ìš”ì— ë”°ë¼ ì»¤ìŠ¤í…€ í•„í„°ë¥¼ ë“±ë¡í•¨
- sessionManagement()ì—ì„œ sessionCreationPolicyë¥¼ STATELESSë¡œ ë“±ë¡í•˜ê¸° ë•Œë¬¸ì— ì„¸ì…˜ì´ ìœ ì§€ë˜ì§€ ì•ŠìŒ
- ëŒ€ì‹  í† í°ì„ ë°œê¸‰í•˜ê³  ë§¤ ìš”ì²­ë§ˆë‹¤ í—¤ë”ì— ìˆëŠ” í† í°ì„ ê²€ì¦í•¨

## JWTUtil

- JWT ë°œê¸‰ ë° ê²€ì¦ì„ ìœ„í•œ í´ë˜ìŠ¤ ìƒì„±
- í›„ìˆ ë˜ëŠ” í•„í„°ë“¤ì—ì„œ ì“°ì„

## UsernamePasswordAuthenticationFilter

- ë¡œê·¸ì¸ ìš”ì²­ ì‹œ ê²€ì¦ í›„ ë¡œê·¸ì¸ ì„±ê³µ ë° JWT ë°œê¸‰ì„ ì§„í–‰í•˜ê¸° ìœ„í•œ í•„í„°
- ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ ìš”ì²­ì„ í•˜ë©´ Spring Securityì˜ UsernamePasswordAuthenticationFilterê°€ ìš”ì²­ì„ ê°€ë¡œì±”
- JWTë¥¼ ì‚¬ìš©í•˜ë©´ formloginì„ ë¹„í™œì„±í™”í•˜ë¯€ë¡œ UsernamePasswordAuthenticationFilterë¥¼ ìƒì† ë°›ì•„ì„œ ì§ì ‘ êµ¬í˜„í•´ì•¼ í•¨
    - attemptAuthentication()ì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì¶”ì¶œ
    - ì¶”ì¶œí•œ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ UsernamePasswordAuthenticationToken ê°™ì€ êµ¬í˜„ì²´ê°€ ìƒì„±ë¨
    - AuthenticationManagerë¥¼ í˜¸ì¶œí•˜ê³  Tokenì„ ë„˜ê¹€
    - ì¸ì¦ì´ ì„±ê³µí•˜ë©´ AuthenticationManagerê°€ ê²€ì¦ëœ Authentication ê°ì²´ë¥¼ ë°˜í™˜
    - successfulAuthentication ë©”ì„œë“œì—ì„œ ì´ Authentication ê°ì²´ë¥¼ ë°›ì•„ ì‚¬ìš©

## OncePerRequestFilter

- ìš”ì²­ì— ë‹´ê¸´ JWTë¥¼ ê²€ì¦í•˜ê¸° ìœ„í•œ í•„í„°
- UsernamePasswordAuthenticationFilter ì•ì— ìœ„ì¹˜ì‹œí‚´
- ê²€ì¦ì— ì„±ê³µí•˜ë©´ Authentication ê°ì²´ ìƒì„± ë° SecurityContextHolderì— ì„¸ì…˜ ìƒì„±
- ì´ ì„¸ì…˜ì€ STATLESS ìƒíƒœë¡œ ê´€ë¦¬ë˜ê¸° ë•Œë¬¸ì— í•´ë‹¹ ìš”ì²­ì´ ëë‚˜ë©´ ì†Œë©¸ë¨

### ë°°í¬ ì‹œ ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ì²´í¬

- proxy.conf
    - ê¸°ì¡´ proxy.conf
        
        ```java
        server {
            server_name onrank.kr www.onrank.kr;
        
            location / {
                proxy_pass <http://172.17.0.2:8080>;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
        
            listen 443 ssl; # managed by Certbot
            ssl_certificate /etc/letsencrypt/live/onrank.kr/fullchain.pem; # managed by Certbot
            ssl_certificate_key /etc/letsencrypt/live/onrank.kr/privkey.pem; # managed by Certbot
            include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
            ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
        
        }
        server {
            if ($host = www.onrank.kr) {
                return 301 https://$host$request_uri;
            } # managed by Certbot
        
            if ($host = onrank.kr) {
                return 301 https://$host$request_uri;
            } # managed by Certbot
        
            listen 80;
            server_name onrank.kr www.onrank.kr;
            return 404; # managed by Certbot
        
        }
        ```
        
    - ë°”ë€ proxy.conf
        
        ```java
        server {
            server_name onrank.kr www.onrank.kr;
        
            location / {
                proxy_pass <http://127.0.0.1:8080>;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
        
            listen 443 ssl; # managed by Certbot
            ssl_certificate /etc/letsencrypt/live/onrank.kr/fullchain.pem; # managed by Certbot
            ssl_certificate_key /etc/letsencrypt/live/onrank.kr/privkey.pem; # managed by Certbot
            include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
            ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
        }
        server {
            if ($host = www.onrank.kr) {
                return 301 https://$host$request_uri;
            } # managed by Certbot
        
            if ($host = onrank.kr) {
                return 301 https://$host$request_uri;
            } # managed by Certbot
        
            listen 80;
            server_name onrank.kr www.onrank.kr;
            return 404; # managed by Certbot
        }
        ```
        
    - `proxy_pass <http://172.17.0.2:8080>;` ì—ì„œ `proxy_pass <http://127.0.0.1:8080>;` ë¡œ ë³€ê²½
        
    - EC2ì„œë²„ì˜ 8080í¬íŠ¸ì™€ Docker ì»¨í…Œì´ë„ˆì˜ 8080 í¬íŠ¸ë¥¼ ë§¤í•‘í•  ê²ƒì´ë¯€ë¡œ ë³€ê²½í•´ë„ ë¨
        
- Dockerfile
    - ê¸°ì¡´ Dockerfile
        
        ```java
        FROM openjdk:21-jdk
        ARG JAR_FILE=build/libs/*.jar
        COPY ${JAR_FILE} app.jar
        ENTRYPOINT ["java", "-Dspring.profiles.active=oauth,aws-db", "-jar", "app.jar"]
        ```
        
    - ë°”ë€ Dockerfile
        
        ```java
        FROM openjdk:21-jdk-slim
        
        RUN apt-get update \\
         && apt-get install -y --no-install-recommends curl \\
         && rm -rf /var/lib/apt/lists/*
        
        ARG JAR_FILE=build/libs/*.jar
        COPY ${JAR_FILE} app.jar
        
        EXPOSE 8080
        
        HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \\
          CMD curl -f <http://127.0.0.1:8081/actuator/health> || exit 1
        
        ENTRYPOINT ["java", "-Dspring.profiles.active=oauth,aws-db", "-jar", "app.jar"]
        ```
        
    - `HEALTHCHECK` ì§€ì‹œì–´ë¥¼ í†µí•´ Dockerê°€ ì»¨í…Œì´ë„ˆì˜ â€œê±´ê°• ìƒíƒœ(health status)â€ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ê²€ì‚¬í•˜ê²Œ í•¨
        
    - ë§¤ 30ì´ˆë§ˆë‹¤ ì§€ì •ëœ ì»¤ë§¨ë“œë¥¼ ì‹¤í–‰í•´ ì»¨í…Œì´ë„ˆ ìƒíƒœë¥¼ í™•ì¸ (`--interval=30s`)
        
    - í—¬ìŠ¤ì²´í¬ ì»¤ë§¨ë“œ(`curl â€¦`)ê°€ **3ì´ˆ ì´ë‚´**ì— ì‘ë‹µí•˜ì§€ ì•Šìœ¼ë©´ ì‹¤íŒ¨ë¡œ ê°„ì£¼ (`--timeout=3s`)
        
    - ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ëœ ë’¤ 60ì´ˆ ë™ì•ˆì€ í—¬ìŠ¤ì²´í¬ ê²°ê³¼ë¥¼ â€œì‹œì‘ ì¤‘(starting)â€ ìƒíƒœë¡œë§Œ ì²˜ë¦¬ â†’ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ê¸°ë™ë˜ëŠ” ì‹œê°„ì„ ë³´ì¥ (`--start-period=60s`)
        
    - í—¬ìŠ¤ì²´í¬ê°€ ì—°ì† 3ë²ˆ ì‹¤íŒ¨í•´ì•¼ë§Œ ìµœì¢…ì ìœ¼ë¡œ ì»¨í…Œì´ë„ˆ ìƒíƒœë¥¼ `unhealthy`ë¡œ ë§ˆí‚¹ (`retries=3`)
        
    - ì‹¤ì œë¡œ ì‹¤í–‰í•  ê²€ì‚¬ ì»¤ë§¨ë“œ (`CMD curl -f <http://127.0.0.1:8081/actuator/health> || exit 1`)
        
        - `curl -f` : HTTP ì‘ë‹µ ì½”ë“œê°€ 4xx/5xxì´ë©´ â€œì¡°ìš©íˆ(fail) ì‹¤íŒ¨â€ ì²˜ë¦¬í•˜ê³  non-zero exit codeë¥¼ ë°˜í™˜
        - `|| exit 1` : `curl`ì´ ì‹¤íŒ¨í–ˆì„ ë•Œ(0ì´ ì•„ë‹Œ ì½”ë“œë¥¼ ë°˜í™˜í–ˆì„ ë•Œ) ê°•ì œë¡œ 1ì„ ë°˜í™˜í•˜ê²Œ í•´ì„œ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ë¡œ ì¸ì‹
- deploy.yml
    - ê¸°ì¡´ deploy.yml
        
        ```java
        name: Deploy to EC2
        
        on:
          push:
            branches: [ "develop" ]  # develop ë¸Œëœì¹˜ì— pushë  ë•Œ ìë™ ë°°í¬
        
        jobs:
          deploy:
            runs-on: ubuntu-latest
        
            steps:
              - name: Checkout source code
                uses: actions/checkout@v3
        
              - name: Generate Docker image tag from Git commit
                id: vars
                run: echo "TAG=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
        
              - name: Deploy via SSH
                uses: appleboy/ssh-action@v1.0.0
                with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_KEY }}
                  script: |
                    echo "[1] ì´ë™: í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ"
                    cd /home/ec2-user/onRank/onRank-spring
        
                    echo "[2] Git ìµœì‹ í™”"
                    git pull origin develop
        
                    echo "[3] ê¸°ì¡´ Docker ì»¨í…Œì´ë„ˆ ì •ë¦¬"
                    docker stop onrank-api || true
                    docker rm onrank-api || true
        
                    echo "[4] Gradle ë¹Œë“œ (ê¸°ì¡´ íŒŒì¼ ì •ë¦¬ í›„ ì¬ë¹Œë“œ)"
                    ./gradlew clean build -x test
        
                    echo "[5] Docker ì´ë¯¸ì§€ ë¹Œë“œ (íƒœê·¸: ${{ env.TAG }})"
                    docker build -t onrank-api:${{ env.TAG }} .
        
                    echo "[6] Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
                    docker run -d --name onrank-api -p 8080:8080 onrank-api:${{ env.TAG }}
        ```
        
    - ë°”ë€ deploy.yml
        
        ```java
        name: Deploy to EC2
        
        on:
          push:
            branches: [ "develop" ]  # develop ë¸Œëœì¹˜ì— pushë  ë•Œ ìë™ ë°°í¬
        
        jobs:
          deploy:
            runs-on: ubuntu-latest
        
            steps:
              - name: Checkout source code
                uses: actions/checkout@v3
        
              - name: Generate Docker image tag from Git commit
                id: vars
                run: echo "TAG=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
        
              - name: Deploy via SSH
                uses: appleboy/ssh-action@v1.0.0
                with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_KEY }}
                  script: |
                    set -e
                    
                    echo "[1] ì´ë™: í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ"
                    cd /home/ec2-user/onRank/onRank-spring
        
                    echo "[2] Git ìµœì‹ í™”"
                    git pull origin develop
        
                    echo "[3] ê¸°ì¡´ Docker ì»¨í…Œì´ë„ˆ ì •ë¦¬ (ì—†ìœ¼ë©´ í•´ë‹¹ ëª…ë ¹ì„ ë¬´ì‹œ)"
                    docker stop onrank-api || true
                    docker rm onrank-api || true
        
                    echo "[4] Gradle ë¹Œë“œ (ê¸°ì¡´ íŒŒì¼ ì •ë¦¬ í›„ ì¬ë¹Œë“œ)"
                    ./gradlew clean build -x test
        
                    echo "[5] Docker ì´ë¯¸ì§€ ë¹Œë“œ (íƒœê·¸: ${{ env.TAG }})"
                    docker build -t onrank-api:${{ env.TAG }} .
        
                    echo "[6] Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
                    docker run -d --name onrank-api -p 8080:8080 onrank-api:${{ env.TAG }}
        
                    echo "[7] Waiting for container to report healthy status..."
                    for i in {1..20}; do
                      HEALTH=$(docker inspect --format='{{.State.Health.Status}}' onrank-api)
                      echo "  â†’ Attempt $i: status=$HEALTH"
                      if [ "$HEALTH" = "healthy" ]; then
                        echo "âœ… Container is healthy!"
                        break
                      fi
                      if [ "$HEALTH" = "unhealthy" ]; then
                        echo "âŒ Container is unhealthy! Dumping logs:"
                        docker logs onrank-api
                        exit 1
                      fi
                      sleep 5
                    done
        ```
        
    - `script`ì—ì„œ `set -e` ì¶”ê°€
        
        - ìŠ¤í¬ë¦½íŠ¸ ì•ˆì—ì„œ ì‹¤í–‰ëœ ì»¤ë§¨ë“œ ì¤‘ í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨(ì¢…ë£Œ ì½”ë“œ â‰ 0)í•˜ë©´ ì¦‰ì‹œ ì „ì²´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¤‘ë‹¨
    - [7]ë‹¨ê³„ ì¶”ê°€
        
        - `Dockerfile`ì— ì˜í•´ ì»¨í…Œì´ë„ˆê°€ `healthy` ìƒíƒœë¡œ ì „í™˜ë  ë•Œê¹Œì§€ ë°˜ë³µí•´ì„œ ìƒíƒœë¥¼ í™•ì¸

### proxy.conf ì¶”ê°€ ë³€ê²½

- ì™¸ë¶€ì—ì„œ `/actuator/health` ë“±ì„ Nginx í†µí•´ í™•ì¸
    
    ```yaml
    location /actuator/ {
        proxy_pass         <http://127.0.0.1:8081>;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }
    ```
    
    - application.ymlì—ì„œ ê³µê°œ ì—”ë“œí¬ì¸íŠ¸ë¡œ `health`ë§Œ ë‚¨ê²¨ë‘ê¸°
    - deploy.yml, Dockerfileë„ ì´ì— ë§ê²Œ í¬íŠ¸ ê´€ë ¨ ì„¤ì • ë³€ê²½

### EBS (Elastic Block Storage)

- EC2 ì¸ìŠ¤í„´ìŠ¤ â†’ ì—°ì‚° ì—­í•  (like CPU, ë©”ëª¨ë¦¬)
- EBS â†’ ë°ì´í„° ì €ì¥ ì—­í•  (like SSD, HHD ì—­í• ), ì¦‰ í´ë¼ìš°ë“œì˜ ê°€ìƒ í•˜ë“œë””ìŠ¤í¬
- EC2 ì¸ìŠ¤í„´ìŠ¤ì— ì‚¬ìš©í•  ì˜êµ¬ ë¸”ë¡ ìŠ¤í† ë¦¬ì§€ ë³¼ë¥¨ ì œê³µ
- EC2 ì¸ìŠ¤í„´ìŠ¤ê°€ ì¢…ë£Œë˜ì–´ë„ ë³„ê°œë¡œ ì‘ë™í•¨
- EC2 ì¸ìŠ¤í„´ìŠ¤ì™€ ë„¤íŠ¸ì›Œí¬ë¡œ ì—°ê²°ë˜ì–´ ìˆìŒ
    - EC2 ì¸ìŠ¤í„´ìŠ¤ ì…ì¥ì—ì„œ ììœ ë¡­ê²Œ EBS êµì²´ í˜¹ì€ ì—¬ëŸ¬ ê°œ ì—°ê²° ê°€ëŠ¥
    - EBS ì…ì¥ì—ì„œ ììœ ë¡­ê²Œ EC2 êµì²´ ë° ì—¬ëŸ¬ ê°œ ì—°ê²° ê°€ëŠ¥

### EBS ë³¼ë¥¨

- EBSë¡œ ìƒì„±í•œ ë””ìŠ¤í¬ í•˜ë‚˜í•˜ë‚˜ì˜ ì €ì¥ ë‹¨ìœ„ (like C, D ë“œë¼ì´ë¸Œ)
- 5ê°€ì§€ íƒ€ì…ìœ¼ë¡œ ë‚˜ë‰¨
    - ë²”ìš©
    - í”„ë¡œë¹„ì €ë‹ëœ IOPS
    - ì“°ë£¨í’‹ ìµœì í™”
    - ì½œë“œ HDD
    - ë§ˆê·¸ë„¤í‹±

### EBSì™€ Instance Storage

- EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ ë‘ ê°€ì§€ ì €ì¥íƒ€ì…
- Instance Storage: ì¸ìŠ¤í„´ìŠ¤ì— ë‚´ì¥ëœ storage

### EBS ë³¼ë¥¨ ìƒì„±, EC2ì— ì—°ê²° í›„ íŒŒì¼ì‹œìŠ¤í…œ í¬ë§·

- EBS ë³¼ë¥¨ì„ EC2ì— ì—°ê²°í•œ í›„ì—ëŠ”, íŒŒì¼ì‹œìŠ¤í…œ í¬ë§·í•´ì¤˜ì•¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ
    - íŒŒì¼ì‹œìŠ¤í…œ
        - ì €ì¥ì¥ì¹˜ì— íŒŒì¼ê³¼ ë””ë ‰í„°ë¦¬ë¥¼ ì–´ë–»ê²Œ ì €ì¥ ë° ì¡°ì§í• ì§€ë¥¼ ì •ì˜í•˜ëŠ” êµ¬ì¡°ì²´ê³„
        - ë¦¬ëˆ…ìŠ¤ì—ì„œ íŒŒì¼ì„ ì½ê³  ì“°ë ¤ë©´ ì´ ì²´ê³„ê°€ ìˆì–´ì•¼ í•¨
        - ë„ì„œê´€ì—ì„œ ì›í•˜ëŠ” ë‚´ìš©ì˜ ì±…ì„ ì°¾ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ë„ì„œê²€ìƒ‰ëŒ€ì™€ ê°™ìŒ

### EBS ë³¼ë¥¨ ë§ˆìš´íŠ¸

- ë§ˆìš´íŠ¸: ë¸”ë¡ ë””ë°”ì´ìŠ¤(ë˜ëŠ” íŒŒí‹°ì…˜) ìœ„ì— ë§Œë“  íŒŒì¼ì‹œìŠ¤í…œì„ ë””ë ‰í„°ë¦¬ íŠ¸ë¦¬ì— ì—°ê²°í•˜ì—¬, ê·¸ ë””ë°”ì´ìŠ¤ ì•ˆì˜ íŒŒì¼ê³¼ í´ë”ë¥¼ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ ë§Œë“œëŠ” ê³¼ì •

### Snapshot

- íŠ¹ì • ì‹œê°„ì— EBS ë³¼ë¥¨ ìƒíƒœì˜ ì €ì¥ë³¸
- OSì™€ ë³„ê°œë¡œ ë°ì´í…€ë§Œ ë°±ì—…í•˜ê³  ì‹¶ì€ ê²½ìš°
- ìŠ¤ëƒ…ìƒ·ì„ ê¸°ë°˜ìœ¼ë¡œ ì—¬ëŸ¬ ì¢…ë¥˜ì˜ AMIë¥¼ ìƒì„±í•˜ê³  ì‹¶ì€ ê²½ìš°
- ì›ë¦¬: ë³€í™”ëœ ë¶€ë¶„ë§Œ ìŠ¤ëƒ…ìƒ·ì„ í•˜ì—¬ ì €ì¥í•˜ë¯€ë¡œ íš¨ìœ¨ì 

### AMI (Amazon Machine Image)

- EC2 ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•œ ì •ë³´ë¥¼ ëª¨ì€ ë‹¨ìœ„
- EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ ì„¸íŒ… ì •ë³´(í…œí”Œë¦¿)ì„ ì €ì¥í•œ ë‹¨ìœ„
- ì»´í“¨í„° OS í™˜ê²½ì„¤ì • ì •ë³´ë¿ë§Œ ì•„ë‹ˆë¼ ì¸ìŠ¤í„´ìŠ¤ì˜ EBSì— ëŒ€í•œ ì •ë³´ë„ ëª¨ë‘ í¬í•¨
- EBSì— ëŒ€í•œ ì •ë³´: ì–´ë–¤ EBS ìŠ¤ëƒ…ìƒ·ê³¼ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ì— ëŒ€í•œ ì •ë³´
- ìš©ë„
    - ê¸´ê¸‰í•˜ê²Œ ë°±ì—…ëœ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë³µêµ¬í•´ì•¼í•˜ëŠ” ê²½ìš°
    - ì¸ìŠ¤í„´ìŠ¤ ì„¤ì • ë“±ì´ ë³µì¡í•´ì„œ ì„¤ì •ì´ ì™„ë£Œëœ ì¸ìŠ¤í„´ìŠ¤ ì´ë¯¸ì§€ë¥¼ ë§Œë“¤ê³  ì‹¶ì€ ê²½ìš°
    - Auto Scaling Group ì—ì„œ ìƒˆ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•˜ê¸° ìœ„í•´ ë§Œë“œëŠ” ê²½ìš°
    - AMIë¥¼ ì‚¬ìš©í•˜ì—¬Â í˜„ì¬ ìƒíƒœì˜ EC2 ì„¸íŒ…(í…œí”Œë¦¿)ì„ ë³µì œí•´ì„œ ë‹¤ë¥¸ ê³„ì •ì´ë‚˜ ë‹¤ë¥¸ ë¦¬ì „ì—ê²Œ ì „ë‹¬
    - í”„ë¡œê·¸ë¨ í˜•íƒœë¡œ AMI ë°°í¬ê°€ ê°€ëŠ¥í•´ ë‹¤ë¥¸ì‚¬ëŒì´ ë°›ì•„ ë‚´ EC2 ìƒíƒœ ê·¸ëŒ€ë¡œë¥¼ ì‚¬ìš©

### AMI ìƒì„± ê³¼ì •

- EBSì˜ ìŠ¤ëƒ…ìƒ·ì„ ì°ìŒ
- ìŠ¤ëƒ…ìƒ·ì—ëŠ” OS, íŒŒì¼, ì‹œì‘ê¶Œí•œ, â€¦ ë“±ì´ ë“¤ì–´ìˆìŒ
- ìŠ¤ëƒ…ìƒ·ì„ S3ì— ì €ì¥
- ìŠ¤ëƒ…ìƒ·ì„ ê¸°ë°˜ìœ¼ë¡œ AMIë¥¼ ë§Œë“¬
- AMIì„ ê°€ì§€ê³  EC2ë¥¼ ì‹¤í–‰í•˜ê±°ë‚˜, ë‹¤ë¥¸ì‚¬ëŒì—ê²Œ ê³µìœ í•˜ê±°ë‚˜ ë³µì‚¬í•¨

### AWSì—ì„œ ë°±ì—”ë“œ ì„œë²„ êµ¬ì¶•

1. (VPC) VPC ìƒì„± (10.0.0.0/20)
2. EC2 ìƒì„±
    1. í‚¤ í˜ì–´ ìƒì„±
    2. í¼ë¸”ë¦­ IP ìë™ í• ë‹¹
    3. ë³´ì•ˆ ê·¸ë£¹ ìƒì„±
3. (VPC) ì¸í„°ë„· ê²Œì´íŠ¸ì›¨ì´ ìƒì„± ë° VPCì— ì—°ê²°
4. (EC2) íƒ„ë ¥ì  IP ì£¼ì†Œ í• ë‹¹
5. (VPC) ì„œë¸Œë„· ìƒì„± (ê° AZ ë³„ë¡œ í•˜ë‚˜ì”©)
6. (RDS) ì„œë¸Œë„· ê·¸ë£¹ ìƒì„±
7. (VPC) VPC DNS í•´ì„(DNS resolution), DNS í˜¸ìŠ¤íŠ¸ ì´ë¦„(DNS hostnames) ê¸°ëŠ¥ í™œì„±í™”
8. RDS ìƒì„±
    1. db.t4g.micro
    2. ë²”ìš© SSD(gp3)
    3. ìŠ¤í† ë¦¬ì§€ ìë™ ì¡°ì • í™œì„±í™” í•´ì œ
    4. ì„œë¸Œë„· ê·¸ë£¹ í• ë‹¹
9. DB ë³´ì•ˆê·¸ë£¹ ìƒì„±
10. EC2, DB ë³´ì•ˆê·¸ë£¹ ì„¤ì •

### ë°°í¬ ì„œë²„ / í…ŒìŠ¤íŠ¸ ì„œë²„ êµ¬ì¶•

- ì„¤ì • íŒŒì¼ ì´ˆê¸°í™”
- .github íŒŒì¼ ì‚­ì œ
- Dockerfile í™•ì¸
- application.yml í™•ì¸
- .gitignore í™•ì¸

### EC2 ë³¼ë¥¨ ìœ í˜• í™•ì¸

```bash
# IMDSv2 í† í° ë°œê¸‰
TOKEN=$(curl -sX PUT "<http://169.254.169.254/latest/api/token>" \\
  -H "X-aws-ec2-metadata-token-ttl-seconds:21600")

# ì¸ìŠ¤í„´ìŠ¤ì— ë¶™ì€ ì—­í•  ì´ë¦„ ì¡°íšŒ
curl -sH "X-aws-ec2-metadata-token: $TOKEN" \\
  <http://169.254.169.254/latest/meta-data/iam/security-credentials/>

# (ìœ„ì— ë‚˜ì˜¨ ì—­í•  ì´ë¦„ì„ ì˜ˆë¡œ ë“¤ë©´)
# ì˜ˆ: EC2-DescribeOnly-Role

# ë³¼ë¥¨ ì •ë³´ ì¡°íšŒ
INSTANCE_ID=$(curl -sH "X-aws-ec2-metadata-token: $TOKEN" \\
  <http://169.254.169.254/latest/meta-data/instance-id>)

aws ec2 describe-volumes \\
  --region ap-northeast-2 \\
  --filters Name=attachment.instance-id,Values=$INSTANCE_ID \\
  --query "Volumes[*].{ID:VolumeId,Type:VolumeType}" \\
  --output table
```

### ì„œë²„ê°€ ì™œ ì£½ì—ˆì„ê¹Œ

ì»¨í…Œì´ë„ˆê°€ ì‚´ì•„ëŠ” ìˆëŠ”ë° Spring Bootê°€ ì œëŒ€ë¡œ ì˜¬ë¼ê°€ì§€ ì•Šì•˜ë‹¤ë©´, ê°€ì¥ í™•ì‹¤í•œ ë°©ë²•ì€ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì— í•œ ë²ˆ ë“¤ì–´ê°€ì„œ ì§ì ‘ í”„ë¡œì„¸ìŠ¤Â·í¬íŠ¸Â·ë¡œê·¸ë¥¼ ì‚´í´ë³´ëŠ” ê±°ì˜ˆìš”.

ì»¨í…Œì´ë„ˆì— ì‰˜ë¡œ ì ‘ì†

```bash
docker exec -it 6a bash
```

í”„ë¡œì„¸ìŠ¤Â·í¬íŠ¸ í™•ì¸

```bash
# í”„ë¡œì„¸ìŠ¤Â·ë„¤íŠ¸ì›Œí¬ ìœ í‹¸ ì„¤ì¹˜
apt-get install -y procps net-tools
```

- ë””ë²„ê¹… í¸ì˜ë¥¼ ìœ„í•´ í˜„ì¬ ë„ìš´ ì»¨í…Œì´ë„ˆ ì•ˆì— ë°”ë¡œ ì„¤ì¹˜í•´ ë³¼ ìˆ˜ ìˆìŒ. ë‹¤ë§Œ ì´ë ‡ê²Œ ì„¤ì¹˜í•œ íŒ¨í‚¤ì§€ëŠ” ì»¨í…Œì´ë„ˆê°€ ë©ˆì·„ì„ ë•Œ ì‚¬ë¼ì§€ë‹ˆ, ìš´ì˜ìš©ìœ¼ë¡  Dockerfileì— ë°˜ì˜í•˜ëŠ” ê²Œ ì¢‹ìŒ